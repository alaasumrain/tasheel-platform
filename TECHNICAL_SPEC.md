# Tasheel Platform - Master Technical Specification

**Project:** Tasheel Service Platform
**Timeline:** 5 weeks (4 phases)
**Budget:** $20,500
**Stack:** Next.js 14, Supabase, TypeScript, Material UI, Tailwind CSS

---

## Table of Contents

1. [Tech Stack & Architecture](#tech-stack--architecture)
2. [Page Layouts & Routes](#page-layouts--routes)
3. [Database Schema](#database-schema)
4. [Core Utilities & Helpers](#core-utilities--helpers)
5. [Security & Performance](#security--performance)
6. [Phase 1: Launch (Week 1)](#phase-1-launch-week-1)
7. [Phase 2: Customers & Payments (Week 2)](#phase-2-customers--payments-week-2)
8. [Phase 3: Team & All Services (Weeks 3-4)](#phase-3-team--all-services-weeks-3-4)
9. [Phase 4: Automation (Week 5)](#phase-4-automation-week-5)
10. [Deployment & DevOps](#deployment--devops)
11. [Testing Checklist](#testing-checklist)
12. [Post-Launch & Maintenance](#post-launch--maintenance)

---

## Tech Stack & Architecture

### Frontend
- **Framework:** Next.js 14.2.26 (App Router)
- **Language:** TypeScript
- **UI Library:** Material UI v6.5
- **Styling:** Tailwind CSS v4
- **Forms:** React Hook Form
- **Validation:** Zod
- **State Management:** TanStack React Query v5.82
- **i18n:** next-intl
- **Animations:** Motion v12.23
- **Charts:** Recharts v3.2
- **Icons:** Tabler Icons React, MUI Icons

### Backend
- **Database:** Supabase (PostgreSQL)
- **Auth:** Supabase Auth
- **Storage:** Supabase Storage
- **Email:** Resend API
- **Payments:** PalPay OR PayTabs (client chooses)
- **PDF Generation:** react-pdf or jsPDF

### DevOps
- **Hosting:** Netlify
- **CI/CD:** Netlify auto-deploy from main branch
- **Domain:** Client provides
- **SSL:** Auto via Netlify

---

## Page Layouts & Routes

### Route Structure Overview

The application uses Next.js 14 App Router with route groups for separation:

```
src/app/
â”œâ”€â”€ (site)/                    # Public-facing website
â”‚   â”œâ”€â”€ layout.tsx            # Header + Footer wrapper
â”‚   â”œâ”€â”€ page.tsx              # Homepage
â”‚   â”œâ”€â”€ about/page.tsx        # About page
â”‚   â”œâ”€â”€ contact/page.tsx      # Contact page
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ page.tsx          # Services catalog
â”‚   â”‚   â””â”€â”€ [slug]/
â”‚   â”‚       â”œâ”€â”€ page.tsx      # Service detail
â”‚   â”‚       â””â”€â”€ quote/page.tsx # Quote request form
â”‚   â”œâ”€â”€ track/page.tsx        # Track order by number
â”‚   â”œâ”€â”€ privacy/page.tsx      # Privacy policy
â”‚   â”œâ”€â”€ terms/page.tsx        # Terms of service
â”‚   â””â”€â”€ cookies/page.tsx      # Cookie policy
â”‚
â”œâ”€â”€ (admin-routes)/           # Admin panel (session-based auth)
â”‚   â”œâ”€â”€ layout.tsx            # Auth check wrapper
â”‚   â”œâ”€â”€ login/page.tsx        # Admin login
â”‚   â””â”€â”€ admin/
â”‚       â”œâ”€â”€ layout.tsx        # Sidebar layout
â”‚       â”œâ”€â”€ page.tsx          # Dashboard
â”‚       â”œâ”€â”€ orders/
â”‚       â”‚   â”œâ”€â”€ page.tsx      # Orders list
â”‚       â”‚   â””â”€â”€ [id]/page.tsx # Order detail
â”‚       â””â”€â”€ settings/page.tsx # Settings
â”‚
â””â”€â”€ (customer-portal)/        # Customer dashboard (Phase 2+)
    â”œâ”€â”€ layout.tsx            # Auth check + dashboard layout
    â”œâ”€â”€ dashboard/
    â”‚   â”œâ”€â”€ page.tsx          # Customer dashboard
    â”‚   â”œâ”€â”€ requests/
    â”‚   â”‚   â”œâ”€â”€ page.tsx      # My requests
    â”‚   â”‚   â””â”€â”€ [id]/page.tsx # Request detail
    â”‚   â”œâ”€â”€ profile/page.tsx  # Profile settings
    â”‚   â””â”€â”€ invoices/page.tsx # My invoices
    â”œâ”€â”€ register/page.tsx     # Customer registration
    â””â”€â”€ login/page.tsx        # Customer login
```

---

### Existing Pages (Currently Built)

#### âœ… Public Website (Site Route Group)

**Homepage** - `/`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header [Logo] [Services] [Track] [Login] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  Hero Section                              â”‚
â”‚  "Tasheel - Government Services Concierge" â”‚
â”‚  [Request Service Button]                  â”‚
â”‚                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Partners Logos                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Features Grid (3 columns)                 â”‚
â”‚  [Icon] [Icon] [Icon]                      â”‚
â”‚  Feature Feature Feature                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Services Catalog Preview (6 services)     â”‚
â”‚  [Card] [Card] [Card]                      â”‚
â”‚  [Card] [Card] [Card]                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Reviews / Testimonials                    â”‚
â”‚  Video Section                             â”‚
â”‚  Process Steps                             â”‚
â”‚  FAQ Accordion                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Footer [Links] [Contact] [Social]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Components Used:**
- `<Hero />` - Hero section with CTA
- `<Partners />` - Partner logos slider
- `<FeaturesGrid />` - 3-column feature grid
- `<ServicesCatalog />` - Service cards grid
- `<Reviews />` - Customer reviews
- `<Video />` - Promotional video
- `<Process />` - Step-by-step process
- `<FAQ />` - Accordion FAQ section
- `<Testimonials />` - Customer testimonials
- `<Stats />` - Statistics section
- `<PricingPlans />` - Pricing tiers

---

**Services Catalog** - `/services`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Page Title: "Our Services"               â”‚
â”‚  Search: [___________________] ğŸ”          â”‚
â”‚  Filters: [All] [Translation] [Govt] ...  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Services Grid (3 columns)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [Icon]   â”‚ â”‚ [Icon]   â”‚ â”‚ [Icon]   â”‚  â”‚
â”‚  â”‚ Service  â”‚ â”‚ Service  â”‚ â”‚ Service  â”‚  â”‚
â”‚  â”‚ Name     â”‚ â”‚ Name     â”‚ â”‚ Name     â”‚  â”‚
â”‚  â”‚ Price    â”‚ â”‚ Price    â”‚ â”‚ Price    â”‚  â”‚
â”‚  â”‚ Timeframeâ”‚ â”‚ Timeframeâ”‚ â”‚ Timeframeâ”‚  â”‚
â”‚  â”‚ [View]   â”‚ â”‚ [View]   â”‚ â”‚ [View]   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  (Currently 12 services, need 149 total)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Pagination: [1] [2] [3] ...              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Footer                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Data Source:** `services` table in Supabase
**Current Count:** 12 services
**Phase 1 Target:** 30 services
**Phase 3 Target:** 149 services

---

**Service Detail** - `/services/[slug]`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Breadcrumb: Home > Services > [Name]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Service Details   â”‚  â”‚ Quick Quote  â”‚  â”‚
â”‚  â”‚                   â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ [Icon/Image]      â”‚  â”‚ Price: 500â‚ª  â”‚  â”‚
â”‚  â”‚                   â”‚  â”‚ Time: 3 days â”‚  â”‚
â”‚  â”‚ Description       â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ Lorem ipsum...    â”‚  â”‚ [Request     â”‚  â”‚
â”‚  â”‚                   â”‚  â”‚  Quote]      â”‚  â”‚
â”‚  â”‚ What's Included:  â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ âœ“ Item 1          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚ âœ“ Item 2          â”‚                    â”‚
â”‚  â”‚ âœ“ Item 3          â”‚                    â”‚
â”‚  â”‚                   â”‚                    â”‚
â”‚  â”‚ Required Docs:    â”‚                    â”‚
â”‚  â”‚ â€¢ Document A      â”‚                    â”‚
â”‚  â”‚ â€¢ Document B      â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Related Services (3 cards)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Footer                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Components Used:**
- `<ServiceDetail />` - Main service information
- `<ServiceQuoteSidebar />` - Sticky CTA sidebar

---

**Quote Request Form** - `/services/[slug]/quote`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Service: [Service Name]                   â”‚
â”‚  Price: 500â‚ª | Turnaround: 3 days         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Quote Request Form                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Your Information                   â”‚   â”‚
â”‚  â”‚ Name:     [________________]       â”‚   â”‚
â”‚  â”‚ Email:    [________________]       â”‚   â”‚
â”‚  â”‚ Phone:    [________________]       â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚ Service Details                    â”‚   â”‚
â”‚  â”‚ Message:  [________________]       â”‚   â”‚
â”‚  â”‚           [________________]       â”‚   â”‚
â”‚  â”‚           [________________]       â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚ Urgency:  ( ) Standard (3-5 days) â”‚   â”‚
â”‚  â”‚           (â€¢) Express (1-2 days)   â”‚   â”‚
â”‚  â”‚           ( ) Same Day (+50%)      â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚ [Submit Request]                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Footer                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Current State:** Basic form (name, email, phone, message, urgency)
**Phase 1 Enhancement:** Add service-specific fields (see Core Utilities 3.2)

---

**Track Order** - `/track`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Track Your Order                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Order Number:                      â”‚   â”‚
â”‚  â”‚ [TSH-20250122-___]      [Track]    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                            â”‚
â”‚  (After search - shows order status)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Order: TSH-20250122-001            â”‚   â”‚
â”‚  â”‚ Service: ID Card Renewal           â”‚   â”‚
â”‚  â”‚ Status: In Progress                â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚ Timeline:                          â”‚   â”‚
â”‚  â”‚ â— Submitted - Jan 22, 2025         â”‚   â”‚
â”‚  â”‚ â— Screening - Jan 22, 2025         â”‚   â”‚
â”‚  â”‚ â—‹ In Process                       â”‚   â”‚
â”‚  â”‚ â—‹ Ready for Pickup                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Footer                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Current State:** Page exists, needs backend connection
**Phase 1:** Connect to `applications` table, show basic status
**Phase 2:** Add timeline from `application_events` table

---

#### âœ… Admin Panel (Admin Routes Group)

**Admin Login** - `/login`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Logo]                                    â”‚
â”‚                                            â”‚
â”‚  Admin Login                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Email:    [________________]       â”‚   â”‚
â”‚  â”‚ Password: [________________]       â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚ [Login]                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Auth:** Session-based (cookies), checked in layout.tsx
**Current:** Working with basic credentials
**Phase 3:** Add proper user management with roles

---

**Admin Dashboard** - `/admin`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Logo]   â”‚ Tasheel Admin                    â”‚
â”‚ Tasheel  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚                                  â”‚
â”‚ â— Dash   â”‚  Overview Stats                  â”‚
â”‚ â—‹ Orders â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â—‹ Settingsâ”‚ â”‚ Total  â”‚ â”‚ Pendingâ”‚ â”‚ Rev  â”‚ â”‚
â”‚          â”‚  â”‚ Orders â”‚ â”‚ Orders â”‚ â”‚ MTD  â”‚ â”‚
â”‚ [Logout] â”‚  â”‚  142   â”‚ â”‚   23   â”‚ â”‚ 12Kâ‚ª â”‚ â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                  â”‚
â”‚  260px   â”‚  Recent Orders                   â”‚
â”‚  Sidebar â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚          â”‚  â”‚ TSH-001 | Customer | ... â”‚   â”‚
â”‚          â”‚  â”‚ TSH-002 | Customer | ... â”‚   â”‚
â”‚          â”‚  â”‚ TSH-003 | Customer | ... â”‚   â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Components:**
- `<AdminLayout>` - Sidebar + AppBar + main content
- Stats cards (currently placeholder)
- Recent orders table

**Current State:** Basic layout working
**Phase 1:** Add real stats from database
**Phase 4:** Add charts (Recharts)

---

**Orders List** - `/admin/orders`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sidebar  â”‚ Orders Management                â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ Search: [________] ğŸ” Filters    â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚          â”‚ â”‚ Order# â”‚ Customer â”‚ Status  â”‚ â”‚
â”‚          â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚          â”‚ â”‚ TSH-001â”‚ John Doe â”‚ New     â”‚ â”‚
â”‚          â”‚ â”‚ TSH-002â”‚ Jane S.  â”‚ Process â”‚ â”‚
â”‚          â”‚ â”‚ TSH-003â”‚ Ali K.   â”‚ Ready   â”‚ â”‚
â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚ Pagination: [1] [2] [3]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Current State:** Table with basic data
**Phase 1:** Add search, filters, pagination
**Phase 2:** Add bulk actions
**Phase 3:** Add assignment, SLA indicators

---

**Order Detail** - `/admin/orders/[id]`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sidebar  â”‚ Order #TSH-20250122-001          â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ Customer: John Doe               â”‚
â”‚          â”‚ Service: ID Card Renewal         â”‚
â”‚          â”‚ Status: [Dropdown]   [Update]    â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ Details                          â”‚
â”‚          â”‚ Submitted: Jan 22, 2025 10:30 AM â”‚
â”‚          â”‚ Urgency: Express                 â”‚
â”‚          â”‚ Message: "Need urgently..."      â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ Activity Timeline                â”‚
â”‚          â”‚ â— Submitted - Jan 22 10:30 AM    â”‚
â”‚          â”‚ â— Assigned to Officer - 10:45    â”‚
â”‚          â”‚ â—‹ In Progress                    â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ Actions                          â”‚
â”‚          â”‚ [Create Quote] [Add Note]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Current State:** Basic detail view
**Phase 1:** Add status updates, notes
**Phase 2:** Add quote creation, file uploads, invoicing
**Phase 3:** Add task creation, assignment

---

### Missing Pages (To Be Built)

#### âŒ Customer Portal (Phase 2)

**Customer Registration** - `/register`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Create Your Account                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Full Name:  [________________]     â”‚   â”‚
â”‚  â”‚ Email:      [________________]     â”‚   â”‚
â”‚  â”‚ Phone:      [________________]     â”‚   â”‚
â”‚  â”‚ Password:   [________________]     â”‚   â”‚
â”‚  â”‚ Confirm:    [________________]     â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚ [Create Account]                   â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚ Already have account? [Login]      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Footer                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tech:** Supabase Auth (auth.signUp)
**Redirect:** â†’ `/dashboard` after registration

---

**Customer Login** - `/customer/login`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Login to Your Account                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Email:    [________________]       â”‚   â”‚
â”‚  â”‚ Password: [________________]       â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚ [ ] Remember me                    â”‚   â”‚
â”‚  â”‚ Forgot password?                   â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚ [Login]                            â”‚   â”‚
â”‚  â”‚                                    â”‚   â”‚
â”‚  â”‚ Don't have account? [Register]     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Footer                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tech:** Supabase Auth (auth.signInWithPassword)
**Redirect:** â†’ `/dashboard`

---

**Customer Dashboard** - `/dashboard`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Sidebar Navigation                         â”‚
â”‚ â— Dashboard                                â”‚
â”‚ â—‹ My Requests                              â”‚
â”‚ â—‹ Invoices                                 â”‚
â”‚ â—‹ Profile                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Welcome, John!                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Active   â”‚ â”‚ Completedâ”‚ â”‚ Total    â”‚  â”‚
â”‚  â”‚ Requests â”‚ â”‚ This Mo. â”‚ â”‚ Spent    â”‚  â”‚
â”‚  â”‚    3     â”‚ â”‚    7     â”‚ â”‚  3,500â‚ª  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                            â”‚
â”‚  Recent Requests                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TSH-001 | ID Renewal  | In Progress  â”‚ â”‚
â”‚  â”‚ TSH-002 | Translation | Ready        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                            â”‚
â”‚  Quick Actions                             â”‚
â”‚  [Request New Service] [Track Order]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**My Requests** - `/dashboard/requests`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header + Sidebar                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  My Requests                               â”‚
â”‚  Filter: [All] [Active] [Completed]        â”‚
â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Order#  â”‚ Service      â”‚ Status      â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ TSH-001 â”‚ ID Renewal   â”‚ In Progress â”‚ â”‚
â”‚  â”‚ TSH-002 â”‚ Translation  â”‚ Ready âœ“     â”‚ â”‚
â”‚  â”‚ TSH-003 â”‚ Birth Cert.  â”‚ Pending Pay â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Request Detail** - `/dashboard/requests/[id]`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header + Sidebar                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Request #TSH-20250122-001                 â”‚
â”‚  Service: ID Card Renewal                  â”‚
â”‚  Status: In Progress                       â”‚
â”‚  SLA: 2 days remaining                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Timeline                                  â”‚
â”‚  â— Submitted - Jan 22, 10:30 AM            â”‚
â”‚  â— Screening - Jan 22, 11:00 AM            â”‚
â”‚  â— In Process - Jan 23, 9:00 AM            â”‚
â”‚  â—‹ Ready for Pickup                        â”‚
â”‚  â—‹ Delivered                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Your Documents                            â”‚
â”‚  ğŸ“„ ID_Copy.pdf [Download]                 â”‚
â”‚  ğŸ“„ Photo.jpg [Download]                   â”‚
â”‚                                            â”‚
â”‚  Upload Additional Files                   â”‚
â”‚  [Choose File] [Upload]                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Invoice                                   â”‚
â”‚  Amount: 500â‚ª                              â”‚
â”‚  Status: Paid âœ“                            â”‚
â”‚  [Download Invoice PDF]                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Completed Work (when ready)               â”‚
â”‚  ğŸ“„ ID_Card_Renewed.pdf [Download]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### âŒ Admin Panel Extensions (Phase 3+)

**User Management** - `/admin/users`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sidebar  â”‚ Team Management                  â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ [+ Add User]  Search: [____]     â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚          â”‚ â”‚ Nameâ”‚ Email â”‚ Role â”‚ Status â”‚ â”‚
â”‚          â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚          â”‚ â”‚ Johnâ”‚ j@..  â”‚Admin â”‚Active â”‚ â”‚
â”‚          â”‚ â”‚ Saraâ”‚ s@..  â”‚Offcr â”‚Active â”‚ â”‚
â”‚          â”‚ â”‚ Ali â”‚ a@..  â”‚Supv  â”‚Active â”‚ â”‚
â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Role Options:** Admin, Supervisor, Officer, Intake Specialist, Auditor

---

**Tasks Management** - `/admin/tasks`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sidebar  â”‚ Tasks & Follow-ups               â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ View: [My Tasks] [All] [Overdue] â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚          â”‚ â”‚ Taskâ”‚ Order â”‚ Due â”‚ Assigneeâ”‚ â”‚
â”‚          â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚          â”‚ â”‚ğŸ”´ Callâ”‚TSH-01â”‚Todayâ”‚ You    â”‚ â”‚
â”‚          â”‚ â”‚ğŸŸ¡ QA  â”‚TSH-02â”‚ +2d â”‚ Sara   â”‚ â”‚
â”‚          â”‚ â”‚ğŸŸ¢ Flw â”‚TSH-03â”‚ +5d â”‚ Ali    â”‚ â”‚
â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Reports & Analytics** - `/admin/reports`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sidebar  â”‚ Reports & Analytics              â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ Date Range: [______] to [______] â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ Revenue Trends (Line Chart)      â”‚
â”‚          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚          â”‚ â”‚     ğŸ“ˆ Revenue Line Chart  â”‚   â”‚
â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                                  â”‚
â”‚          â”‚ Top Services (Pie Chart)         â”‚
â”‚          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚          â”‚ â”‚     ğŸ¥§ Services Breakdown  â”‚   â”‚
â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                                  â”‚
â”‚          â”‚ Team Performance (Bar Chart)     â”‚
â”‚          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚          â”‚ â”‚     ğŸ“Š Officer Stats       â”‚   â”‚
â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                                  â”‚
â”‚          â”‚ [Export to Excel] [Export PDF]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Kanban Board** - `/admin/kanban`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sidebar  â”‚ Workflow Board                   â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ New â”‚ Screening â”‚ In Process â”‚ Ready â”‚Done â”‚
â”‚ â”Œâ”€â” â”‚   â”Œâ”€â”    â”‚   â”Œâ”€â”      â”‚ â”Œâ”€â”  â”‚ â”Œâ”€â” â”‚
â”‚ â”‚1â”‚ â”‚   â”‚3â”‚    â”‚   â”‚2â”‚      â”‚ â”‚4â”‚  â”‚ â”‚5â”‚ â”‚
â”‚ â””â”€â”˜ â”‚   â””â”€â”˜    â”‚   â””â”€â”˜      â”‚ â””â”€â”˜  â”‚ â””â”€â”˜ â”‚
â”‚     â”‚   â”Œâ”€â”    â”‚            â”‚      â”‚     â”‚
â”‚     â”‚   â”‚6â”‚    â”‚            â”‚      â”‚     â”‚
â”‚     â”‚   â””â”€â”˜    â”‚            â”‚      â”‚     â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
```

**Tech:** Drag-and-drop with `@dnd-kit/core` or `react-beautiful-dnd`

---

### Component Hierarchy

#### Site Layout Structure
```
<html>
  <body>
    <ThemeProvider>
      <QueryClientProvider>
        <Header />
          â”œâ”€â”€ Logo
          â”œâ”€â”€ Navigation
          â”‚   â”œâ”€â”€ Services
          â”‚   â”œâ”€â”€ About
          â”‚   â”œâ”€â”€ Contact
          â”‚   â””â”€â”€ Track Order
          â””â”€â”€ Auth Buttons
              â”œâ”€â”€ Login
              â””â”€â”€ Register

        <main>
          {children} // Page-specific content
        </main>

        <Footer />
          â”œâ”€â”€ Company Info
          â”œâ”€â”€ Quick Links
          â”œâ”€â”€ Services
          â”œâ”€â”€ Contact
          â””â”€â”€ Social Media
      </QueryClientProvider>
    </ThemeProvider>
  </body>
</html>
```

---

#### Admin Layout Structure
```
<AdminLayout>
  <Box display="flex">
    <Drawer> // Sidebar (260px)
      â”œâ”€â”€ Logo
      â”œâ”€â”€ Navigation
      â”‚   â”œâ”€â”€ Dashboard
      â”‚   â”œâ”€â”€ Orders
      â”‚   â”œâ”€â”€ Users (Phase 3)
      â”‚   â”œâ”€â”€ Tasks (Phase 3)
      â”‚   â”œâ”€â”€ Reports (Phase 4)
      â”‚   â””â”€â”€ Settings
      â””â”€â”€ Logout Button
    </Drawer>

    <AppBar> // Top bar
      â”œâ”€â”€ Mobile Menu Toggle
      â””â”€â”€ Page Title
    </AppBar>

    <Main> // Content area
      {children} // Page-specific admin content
    </Main>
  </Box>
</AdminLayout>
```

---

#### Customer Dashboard Layout (Phase 2)
```
<CustomerDashboardLayout>
  <Box display="flex">
    <Drawer> // Sidebar
      â”œâ”€â”€ Profile Avatar
      â”œâ”€â”€ Navigation
      â”‚   â”œâ”€â”€ Dashboard
      â”‚   â”œâ”€â”€ My Requests
      â”‚   â”œâ”€â”€ Invoices
      â”‚   â””â”€â”€ Profile Settings
      â””â”€â”€ Logout
    </Drawer>

    <Main>
      {children} // Customer dashboard pages
    </Main>
  </Box>
</CustomerDashboardLayout>
```

---

### Key Reusable Components

#### UI Components (`src/components/ui/`)
- `<RevealSection>` - Scroll-triggered animation wrapper
- `<Card>` - Custom styled card (MUI Box wrapper)
- `<Button>` - Custom button variants
- `<LoadingSpinner>` - Loading state indicator
- `<ErrorAlert>` - Error message display
- `<StatusBadge>` - Order status indicator
- `<DataTable>` - Reusable table with sorting/filtering

#### Form Components (`src/components/forms/`)
- `<QuoteRequestForm>` - Service quote form (existing)
- `<LoginForm>` - Auth login form (to build)
- `<RegisterForm>` - Customer registration (to build)
- `<OrderStatusForm>` - Admin status update (to build)
- `<QuoteCreationForm>` - Admin quote creation (to build)
- `<FileUpload>` - Drag-and-drop file upload (to build)

#### Section Components (`src/components/sections/`)
- `<Hero>` - Homepage hero
- `<ServicesCatalog>` - Services grid
- `<ServiceDetail>` - Service detail page
- `<ServiceQuoteSidebar>` - Quote CTA sidebar
- `<FAQ>` - Accordion FAQ
- `<Testimonials>` - Customer reviews
- `<Stats>` - Statistics section
- `<Process>` - Step-by-step process

#### Admin Components (`src/components/admin/`)
- `<AdminLayout>` - Sidebar layout (existing)
- `<OrdersTable>` - Orders list table (to build)
- `<OrderTimeline>` - Activity timeline (to build)
- `<StatsCards>` - Dashboard stat cards (to build)
- `<UserManagementTable>` - Team users table (Phase 3)
- `<TasksTable>` - Tasks list (Phase 3)
- `<KanbanBoard>` - Drag-drop board (Phase 4)
- `<RevenueChart>` - Line chart (Phase 4)
- `<ServicesChart>` - Pie chart (Phase 4)

---

### Responsive Breakpoints (Material UI)

```typescript
const theme = createTheme({
  breakpoints: {
    xs: 0,      // Mobile
    sm: 600,    // Tablet
    md: 900,    // Small desktop
    lg: 1200,   // Desktop
    xl: 1536,   // Large desktop
  }
});
```

**Layout Behavior:**
- **Mobile (xs):** Hamburger menu, stacked layout, full-width cards
- **Tablet (sm-md):** Collapsible sidebar, 2-column grids
- **Desktop (lg+):** Permanent sidebar, 3-column grids, enhanced spacing

---

### Design System Colors

```typescript
// Primary (Blue)
primary: {
  main: '#1976d2',
  light: '#42a5f5',
  dark: '#1565c0',
}

// Secondary (Green)
secondary: {
  main: '#388e3c',
  light: '#66bb6a',
  dark: '#2e7d32',
}

// Status Colors
success: '#4caf50',  // Green (Completed, Paid)
warning: '#ff9800',  // Orange (At Risk, Pending)
error: '#f44336',    // Red (Overdue, Failed)
info: '#2196f3',     // Blue (In Progress)

// Text
text: {
  primary: 'rgba(0, 0, 0, 0.87)',
  secondary: 'rgba(0, 0, 0, 0.6)',
}
```

---

### Typography Scale

```typescript
h1: { fontSize: '3.5rem', fontWeight: 700 },  // Page titles
h2: { fontSize: '2.5rem', fontWeight: 700 },  // Section headers
h3: { fontSize: '2rem', fontWeight: 600 },    // Card titles
h4: { fontSize: '1.5rem', fontWeight: 600 },  // Subsections
h5: { fontSize: '1.25rem', fontWeight: 600 }, // Small headers
h6: { fontSize: '1rem', fontWeight: 600 },    // Labels
body1: { fontSize: '1rem' },                  // Body text
body2: { fontSize: '0.875rem' },              // Secondary text
```

---

## Database Schema

### Phase 1 Tables

#### `customers`
```sql
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT UNIQUE NOT NULL,
  phone TEXT,
  name TEXT,
  language_preference TEXT DEFAULT 'ar', -- 'ar' or 'en'
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### `services`
```sql
CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  slug TEXT UNIQUE NOT NULL,
  name_en TEXT NOT NULL,
  name_ar TEXT NOT NULL,
  description_en TEXT,
  description_ar TEXT,
  category TEXT NOT NULL, -- 'government', 'translation', 'legalization', 'business'
  price NUMERIC, -- null means "Request Quote"
  turnaround_days INTEGER,
  required_documents_en JSONB, -- array of strings
  required_documents_ar JSONB,
  process_steps_en JSONB, -- array of {title, description}
  process_steps_ar JSONB,
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### `applications` (quote requests)
```sql
CREATE TABLE applications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  order_number TEXT UNIQUE NOT NULL, -- auto-generated "TSH-20250115-001"
  customer_id UUID REFERENCES customers(id),
  service_id UUID REFERENCES services(id),

  -- Customer info (denormalized for when customer not logged in)
  customer_name TEXT,
  customer_email TEXT NOT NULL,
  customer_phone TEXT,

  -- Request details
  urgency TEXT DEFAULT 'standard', -- 'standard', 'express', 'urgent'
  message TEXT,
  payload JSONB, -- service-specific form data

  -- Status
  status TEXT DEFAULT 'new', -- 'new', 'in_progress', 'review', 'completed', 'cancelled'
  assigned_to UUID REFERENCES users(id),

  -- Timestamps
  submitted_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### `application_events` (audit trail)
```sql
CREATE TABLE application_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  application_id UUID REFERENCES applications(id) ON DELETE CASCADE,
  event_type TEXT NOT NULL, -- 'submitted', 'status_changed', 'assigned', 'note_added'
  user_id UUID REFERENCES users(id), -- null if system event
  notes TEXT,
  data JSONB, -- event-specific data
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### `users` (admin/staff)
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  name TEXT NOT NULL,
  role TEXT DEFAULT 'officer', -- 'admin', 'officer' in Phase 1; adds more in Phase 3
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Phase 2 Tables

#### `files`
```sql
CREATE TABLE files (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  application_id UUID REFERENCES applications(id) ON DELETE CASCADE,
  filename TEXT NOT NULL,
  file_path TEXT NOT NULL, -- Supabase Storage path
  file_size INTEGER,
  file_type TEXT,
  uploaded_by UUID REFERENCES users(id), -- null if customer upload
  is_customer_upload BOOLEAN DEFAULT false,
  is_completed_work BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### `invoices`
```sql
CREATE TABLE invoices (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  application_id UUID REFERENCES applications(id) ON DELETE CASCADE,
  invoice_number TEXT UNIQUE NOT NULL, -- "INV-20250115-001"
  amount NUMERIC NOT NULL,
  currency TEXT DEFAULT 'ILS',
  status TEXT DEFAULT 'pending', -- 'pending', 'paid', 'failed', 'cancelled'
  payment_link TEXT,
  paid_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### `payments`
```sql
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  invoice_id UUID REFERENCES invoices(id) ON DELETE CASCADE,
  gateway TEXT NOT NULL, -- 'palpal', 'paytabs'
  transaction_id TEXT,
  amount NUMERIC NOT NULL,
  status TEXT DEFAULT 'pending', -- 'pending', 'completed', 'failed'
  gateway_response JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Phase 3 Tables

#### Update `users` table
```sql
ALTER TABLE users
ADD COLUMN team_id UUID REFERENCES teams(id),
ADD COLUMN permissions JSONB; -- role-specific permissions

-- Add new roles: 'supervisor', 'intake', 'auditor'
```

#### `teams`
```sql
CREATE TABLE teams (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### `tasks`
```sql
CREATE TABLE tasks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  application_id UUID REFERENCES applications(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  type TEXT NOT NULL, -- 'call', 'whatsapp', 'email', 'office_visit', 'ministry', 'qa'
  assigned_to UUID REFERENCES users(id),
  created_by UUID REFERENCES users(id),
  due_date TIMESTAMPTZ,
  priority TEXT DEFAULT 'normal', -- 'low', 'normal', 'high', 'urgent'
  status TEXT DEFAULT 'open', -- 'open', 'in_progress', 'done', 'cancelled'
  time_spent_minutes INTEGER,
  outcome_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### `sla_configs`
```sql
CREATE TABLE sla_configs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  service_id UUID REFERENCES services(id) UNIQUE,
  target_hours INTEGER NOT NULL, -- business hours
  warning_threshold_percent INTEGER DEFAULT 70,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### `communications`
```sql
CREATE TABLE communications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  application_id UUID REFERENCES applications(id) ON DELETE CASCADE,
  channel TEXT NOT NULL, -- 'call', 'email', 'whatsapp', 'office_visit'
  user_id UUID REFERENCES users(id),
  summary TEXT,
  next_followup_date TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Phase 4 Tables

#### `automation_logs`
```sql
CREATE TABLE automation_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  automation_type TEXT NOT NULL, -- 'task_created', 'sla_warning', 'payment_reminder'
  application_id UUID REFERENCES applications(id),
  task_id UUID REFERENCES tasks(id),
  status TEXT DEFAULT 'success', -- 'success', 'failed'
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 3. Core Utilities & Helpers

### 3.1 Order Number Generation

**Format:** `TSH-YYYYMMDD-XXX` (e.g., `TSH-20250122-001`)

**Implementation:**

```typescript
// lib/utils/order-number.ts
import { createClient } from '@/lib/supabase/server';

export async function generateOrderNumber(): Promise<string> {
  const supabase = await createClient();

  // Get today's date in Palestine timezone (UTC+2)
  const today = new Date();
  const palestineDate = new Date(today.toLocaleString('en-US', { timeZone: 'Asia/Gaza' }));
  const dateStr = palestineDate.toISOString().split('T')[0].replace(/-/g, '');

  // Get count of orders created today
  const { count, error } = await supabase
    .from('applications')
    .select('*', { count: 'exact', head: true })
    .gte('created_at', `${palestineDate.toISOString().split('T')[0]} 00:00:00+02`)
    .lt('created_at', `${palestineDate.toISOString().split('T')[0]} 23:59:59+02`);

  if (error) throw error;

  const sequence = String((count || 0) + 1).padStart(3, '0');

  return `TSH-${dateStr}-${sequence}`;
}

// Usage in API route
export async function POST(request: Request) {
  const orderNumber = await generateOrderNumber();

  const { data, error } = await supabase
    .from('applications')
    .insert({ order_number: orderNumber, ...otherData })
    .select()
    .single();

  return NextResponse.json({ data, error });
}
```

**Edge Cases:**
- Multiple simultaneous requests â†’ Use database transaction with row-level locking
- Date rollover at midnight â†’ Always use Palestine timezone
- Sequence overflow (>999) â†’ Log warning, continue with 4 digits

---

### 3.2 Service Form Fields Configuration

**Dynamic fields per service type:**

```typescript
// lib/config/service-fields.ts
export type FieldType = 'text' | 'email' | 'phone' | 'file' | 'select' | 'date' | 'textarea' | 'number';

export interface ServiceField {
  name: string;
  type: FieldType;
  label_ar: string;
  label_en: string;
  required: boolean;
  placeholder_ar?: string;
  placeholder_en?: string;
  options?: { value: string; label_ar: string; label_en: string }[];
  validation?: {
    min?: number;
    max?: number;
    pattern?: string;
    maxFileSize?: number; // in MB
    acceptedFileTypes?: string[];
  };
}

export const SERVICE_FORM_FIELDS: Record<string, ServiceField[]> = {
  // Translation Services
  'translation-document': [
    {
      name: 'source_language',
      type: 'select',
      label_ar: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…ØµØ¯Ø±',
      label_en: 'Source Language',
      required: true,
      options: [
        { value: 'ar', label_ar: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', label_en: 'Arabic' },
        { value: 'en', label_ar: 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', label_en: 'English' },
        { value: 'he', label_ar: 'Ø§Ù„Ø¹Ø¨Ø±ÙŠØ©', label_en: 'Hebrew' }
      ]
    },
    {
      name: 'target_language',
      type: 'select',
      label_ar: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©',
      label_en: 'Target Language',
      required: true,
      options: [
        { value: 'ar', label_ar: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', label_en: 'Arabic' },
        { value: 'en', label_ar: 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', label_en: 'English' },
        { value: 'he', label_ar: 'Ø§Ù„Ø¹Ø¨Ø±ÙŠØ©', label_en: 'Hebrew' }
      ]
    },
    {
      name: 'document_type',
      type: 'select',
      label_ar: 'Ù†ÙˆØ¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©',
      label_en: 'Document Type',
      required: true,
      options: [
        { value: 'passport', label_ar: 'Ø¬ÙˆØ§Ø² Ø³ÙØ±', label_en: 'Passport' },
        { value: 'id_card', label_ar: 'Ø¨Ø·Ø§Ù‚Ø© Ù‡ÙˆÙŠØ©', label_en: 'ID Card' },
        { value: 'birth_certificate', label_ar: 'Ø´Ù‡Ø§Ø¯Ø© Ù…ÙŠÙ„Ø§Ø¯', label_en: 'Birth Certificate' },
        { value: 'academic', label_ar: 'Ø´Ù‡Ø§Ø¯Ø© Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©', label_en: 'Academic Certificate' },
        { value: 'legal', label_ar: 'ÙˆØ«ÙŠÙ‚Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©', label_en: 'Legal Document' },
        { value: 'medical', label_ar: 'ÙˆØ«ÙŠÙ‚Ø© Ø·Ø¨ÙŠØ©', label_en: 'Medical Document' }
      ]
    },
    {
      name: 'page_count',
      type: 'number',
      label_ar: 'Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª',
      label_en: 'Number of Pages',
      required: true,
      validation: { min: 1, max: 100 }
    },
    {
      name: 'certified_translation',
      type: 'select',
      label_ar: 'ØªØ±Ø¬Ù…Ø© Ù…Ø¹ØªÙ…Ø¯Ø©ØŸ',
      label_en: 'Certified Translation?',
      required: true,
      options: [
        { value: 'yes', label_ar: 'Ù†Ø¹Ù…', label_en: 'Yes' },
        { value: 'no', label_ar: 'Ù„Ø§', label_en: 'No' }
      ]
    },
    {
      name: 'urgency',
      type: 'select',
      label_ar: 'Ø§Ù„Ø§Ø³ØªØ¹Ø¬Ø§Ù„',
      label_en: 'Urgency',
      required: true,
      options: [
        { value: 'standard', label_ar: 'Ø¹Ø§Ø¯ÙŠ (3-5 Ø£ÙŠØ§Ù…)', label_en: 'Standard (3-5 days)' },
        { value: 'express', label_ar: 'Ø³Ø±ÙŠØ¹ (1-2 ÙŠÙˆÙ…)', label_en: 'Express (1-2 days)' },
        { value: 'same_day', label_ar: 'Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…', label_en: 'Same Day' }
      ]
    },
    {
      name: 'document_file',
      type: 'file',
      label_ar: 'Ø§Ø±ÙØ¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©',
      label_en: 'Upload Document',
      required: true,
      validation: {
        maxFileSize: 10,
        acceptedFileTypes: ['.pdf', '.jpg', '.jpeg', '.png', '.docx']
      }
    }
  ],

  // Government Services - ID Card Renewal
  'id-card-renewal': [
    {
      name: 'full_name',
      type: 'text',
      label_ar: 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„',
      label_en: 'Full Name',
      required: true
    },
    {
      name: 'id_number',
      type: 'text',
      label_ar: 'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©',
      label_en: 'ID Number',
      required: true,
      validation: { pattern: '^[0-9]{9}$' }
    },
    {
      name: 'date_of_birth',
      type: 'date',
      label_ar: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯',
      label_en: 'Date of Birth',
      required: true
    },
    {
      name: 'current_address',
      type: 'textarea',
      label_ar: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ',
      label_en: 'Current Address',
      required: true
    },
    {
      name: 'phone_number',
      type: 'phone',
      label_ar: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ',
      label_en: 'Phone Number',
      required: true,
      validation: { pattern: '^(05)[0-9]{8}$' }
    },
    {
      name: 'old_id_copy',
      type: 'file',
      label_ar: 'Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©',
      label_en: 'Copy of Old ID',
      required: true,
      validation: {
        maxFileSize: 5,
        acceptedFileTypes: ['.pdf', '.jpg', '.jpeg', '.png']
      }
    },
    {
      name: 'personal_photo',
      type: 'file',
      label_ar: 'ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©',
      label_en: 'Personal Photo',
      required: true,
      validation: {
        maxFileSize: 2,
        acceptedFileTypes: ['.jpg', '.jpeg', '.png']
      }
    }
  ],

  // Business Services - Company Registration
  'company-registration': [
    {
      name: 'company_name_ar',
      type: 'text',
      label_ar: 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
      label_en: 'Company Name (Arabic)',
      required: true
    },
    {
      name: 'company_name_en',
      type: 'text',
      label_ar: 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',
      label_en: 'Company Name (English)',
      required: true
    },
    {
      name: 'company_type',
      type: 'select',
      label_ar: 'Ù†ÙˆØ¹ Ø§Ù„Ø´Ø±ÙƒØ©',
      label_en: 'Company Type',
      required: true,
      options: [
        { value: 'llc', label_ar: 'Ø´Ø±ÙƒØ© Ù…Ø­Ø¯ÙˆØ¯Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©', label_en: 'Limited Liability Company' },
        { value: 'partnership', label_ar: 'Ø´Ø±ÙƒØ© ØªØ¶Ø§Ù…Ù†ÙŠØ©', label_en: 'Partnership' },
        { value: 'sole', label_ar: 'Ù…Ø¤Ø³Ø³Ø© ÙØ±Ø¯ÙŠØ©', label_en: 'Sole Proprietorship' }
      ]
    },
    {
      name: 'business_activity',
      type: 'textarea',
      label_ar: 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØªØ¬Ø§Ø±ÙŠ',
      label_en: 'Business Activity',
      required: true
    },
    {
      name: 'capital_amount',
      type: 'number',
      label_ar: 'Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (Ø´ÙŠÙƒÙ„)',
      label_en: 'Capital Amount (ILS)',
      required: true,
      validation: { min: 1000 }
    },
    {
      name: 'partners_count',
      type: 'number',
      label_ar: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø±ÙƒØ§Ø¡',
      label_en: 'Number of Partners',
      required: true,
      validation: { min: 1, max: 50 }
    },
    {
      name: 'partners_ids',
      type: 'file',
      label_ar: 'Ù†Ø³Ø® Ù‡ÙˆÙŠØ§Øª Ø§Ù„Ø´Ø±ÙƒØ§Ø¡',
      label_en: 'Partners ID Copies',
      required: true,
      validation: {
        maxFileSize: 10,
        acceptedFileTypes: ['.pdf', '.zip']
      }
    }
  ]
};

// Helper function to get fields for a service
export function getServiceFields(serviceSlug: string): ServiceField[] {
  return SERVICE_FORM_FIELDS[serviceSlug] || [];
}

// Form validation helper
export function validateFormData(
  serviceSlug: string,
  formData: Record<string, any>
): { valid: boolean; errors: Record<string, string> } {
  const fields = getServiceFields(serviceSlug);
  const errors: Record<string, string> = {};

  fields.forEach((field) => {
    const value = formData[field.name];

    // Required field check
    if (field.required && (!value || value === '')) {
      errors[field.name] = 'This field is required';
      return;
    }

    // Type-specific validation
    if (value && field.validation) {
      if (field.type === 'number') {
        const num = Number(value);
        if (field.validation.min && num < field.validation.min) {
          errors[field.name] = `Minimum value is ${field.validation.min}`;
        }
        if (field.validation.max && num > field.validation.max) {
          errors[field.name] = `Maximum value is ${field.validation.max}`;
        }
      }

      if (field.type === 'text' && field.validation.pattern) {
        const regex = new RegExp(field.validation.pattern);
        if (!regex.test(value)) {
          errors[field.name] = 'Invalid format';
        }
      }
    }
  });

  return {
    valid: Object.keys(errors).length === 0,
    errors
  };
}
```

**Database Storage:**

```sql
-- Store form data as JSONB in applications table
ALTER TABLE applications ADD COLUMN form_data JSONB;

-- Example stored data
{
  "source_language": "ar",
  "target_language": "en",
  "document_type": "passport",
  "page_count": 5,
  "certified_translation": "yes",
  "urgency": "express"
}
```

---

### 3.3 File Storage Structure

**Supabase Storage Buckets:**

```typescript
// lib/config/storage.ts
export const STORAGE_BUCKETS = {
  CUSTOMER_UPLOADS: 'customer-uploads',     // Customer-submitted files
  COMPLETED_WORK: 'completed-work',         // Team-uploaded deliverables
  INVOICES: 'invoices',                     // Generated PDF invoices
  TEAM_AVATARS: 'team-avatars',            // Staff profile photos
  SERVICE_IMAGES: 'service-images'         // Service catalog images
} as const;

// File path structure
export function getUploadPath(
  bucket: keyof typeof STORAGE_BUCKETS,
  applicationId: string,
  fileName: string
): string {
  const timestamp = Date.now();
  const sanitized = fileName.replace(/[^a-zA-Z0-9.-]/g, '_');

  switch (bucket) {
    case 'CUSTOMER_UPLOADS':
      // customer-uploads/2025/01/app-uuid/timestamp-filename.pdf
      return `${new Date().getFullYear()}/${String(new Date().getMonth() + 1).padStart(2, '0')}/${applicationId}/${timestamp}-${sanitized}`;

    case 'COMPLETED_WORK':
      // completed-work/2025/01/app-uuid/final-timestamp-filename.pdf
      return `${new Date().getFullYear()}/${String(new Date().getMonth() + 1).padStart(2, '0')}/${applicationId}/final-${timestamp}-${sanitized}`;

    case 'INVOICES':
      // invoices/2025/01/INV-20250122-001.pdf
      return `${new Date().getFullYear()}/${String(new Date().getMonth() + 1).padStart(2, '0')}/INV-${Date.now()}-${sanitized}`;

    default:
      return `${applicationId}/${timestamp}-${sanitized}`;
  }
}

// File upload helper
export async function uploadFile(
  bucket: keyof typeof STORAGE_BUCKETS,
  applicationId: string,
  file: File
): Promise<{ path: string; url: string; error?: string }> {
  const supabase = createClient();

  const path = getUploadPath(bucket, applicationId, file.name);

  const { data, error } = await supabase.storage
    .from(STORAGE_BUCKETS[bucket])
    .upload(path, file, {
      cacheControl: '3600',
      upsert: false
    });

  if (error) {
    return { path: '', url: '', error: error.message };
  }

  // Generate signed URL (valid for 1 year)
  const { data: urlData } = await supabase.storage
    .from(STORAGE_BUCKETS[bucket])
    .createSignedUrl(path, 31536000);

  return {
    path: data.path,
    url: urlData?.signedUrl || '',
  };
}

// File download helper (for customers)
export async function getDownloadUrl(
  bucket: keyof typeof STORAGE_BUCKETS,
  filePath: string,
  expiresIn: number = 3600 // 1 hour
): Promise<string | null> {
  const supabase = createClient();

  const { data } = await supabase.storage
    .from(STORAGE_BUCKETS[bucket])
    .createSignedUrl(filePath, expiresIn);

  return data?.signedUrl || null;
}
```

**Bucket Policies (Supabase Dashboard):**

```sql
-- Customer uploads: Customers can upload to their own applications
CREATE POLICY "Customers can upload files"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'customer-uploads' AND
  (storage.foldername(name))[3] IN (
    SELECT id::text FROM applications WHERE customer_id = auth.uid()
  )
);

-- Completed work: Only team can upload
CREATE POLICY "Team can upload completed work"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'completed-work' AND
  auth.uid() IN (SELECT id FROM users WHERE role IN ('admin', 'supervisor', 'officer'))
);

-- Customers can download their completed work
CREATE POLICY "Customers can download their files"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'completed-work' AND
  (storage.foldername(name))[3] IN (
    SELECT id::text FROM applications WHERE customer_id = auth.uid()
  )
);
```

---

### 3.4 Palestinian Business Hours Calculator

**Excludes weekends (Friday/Saturday) and Palestinian holidays:**

```typescript
// lib/utils/business-hours.ts
export const PALESTINIAN_HOLIDAYS_2025 = [
  '2025-01-01', // New Year
  '2025-03-29', // Eid al-Fitr (estimated)
  '2025-03-30', // Eid al-Fitr Day 2
  '2025-03-31', // Eid al-Fitr Day 3
  '2025-06-06', // Eid al-Adha (estimated)
  '2025-06-07', // Eid al-Adha Day 2
  '2025-06-08', // Eid al-Adha Day 3
  '2025-06-09', // Eid al-Adha Day 4
  '2025-06-27', // Islamic New Year (estimated)
  '2025-09-05', // Prophet's Birthday (estimated)
  '2025-11-15', // Independence Day
  '2025-12-25', // Christmas
];

export const BUSINESS_HOURS = {
  START: 8, // 8 AM
  END: 16,  // 4 PM
  DAILY_HOURS: 8
};

export function isBusinessDay(date: Date): boolean {
  const day = date.getDay();
  const dateStr = date.toISOString().split('T')[0];

  // Friday (5) and Saturday (6) are weekends in Palestine
  if (day === 5 || day === 6) return false;

  // Check if it's a holiday
  if (PALESTINIAN_HOLIDAYS_2025.includes(dateStr)) return false;

  return true;
}

export function calculateBusinessHours(
  startDate: Date,
  endDate: Date
): number {
  let totalHours = 0;
  let current = new Date(startDate);

  while (current <= endDate) {
    if (isBusinessDay(current)) {
      const currentHour = current.getHours();
      const endHour = current.toDateString() === endDate.toDateString()
        ? endDate.getHours()
        : BUSINESS_HOURS.END;

      // Calculate hours within business hours
      const startHour = Math.max(currentHour, BUSINESS_HOURS.START);
      const endWorkHour = Math.min(endHour, BUSINESS_HOURS.END);

      if (startHour < endWorkHour) {
        totalHours += endWorkHour - startHour;
      }
    }

    // Move to next day
    current.setDate(current.getDate() + 1);
    current.setHours(BUSINESS_HOURS.START, 0, 0, 0);
  }

  return totalHours;
}

export function addBusinessHours(
  startDate: Date,
  hoursToAdd: number
): Date {
  let current = new Date(startDate);
  let remainingHours = hoursToAdd;

  while (remainingHours > 0) {
    if (isBusinessDay(current)) {
      const currentHour = current.getHours();

      // If we're before business hours, jump to start
      if (currentHour < BUSINESS_HOURS.START) {
        current.setHours(BUSINESS_HOURS.START, 0, 0, 0);
      }

      // If we're after business hours, jump to next business day
      if (currentHour >= BUSINESS_HOURS.END) {
        current.setDate(current.getDate() + 1);
        current.setHours(BUSINESS_HOURS.START, 0, 0, 0);
        continue;
      }

      // Calculate hours available today
      const hoursLeftToday = BUSINESS_HOURS.END - current.getHours();

      if (remainingHours <= hoursLeftToday) {
        current.setHours(current.getHours() + remainingHours);
        remainingHours = 0;
      } else {
        remainingHours -= hoursLeftToday;
        current.setDate(current.getDate() + 1);
        current.setHours(BUSINESS_HOURS.START, 0, 0, 0);
      }
    } else {
      // Skip to next day
      current.setDate(current.getDate() + 1);
      current.setHours(BUSINESS_HOURS.START, 0, 0, 0);
    }
  }

  return current;
}

// Example usage in SLA calculation
export function calculateSLADeadline(
  submittedAt: Date,
  turnaroundHours: number
): {
  deadline: Date;
  businessHoursRemaining: number;
  status: 'on_track' | 'at_risk' | 'breached';
} {
  const deadline = addBusinessHours(submittedAt, turnaroundHours);
  const now = new Date();
  const elapsed = calculateBusinessHours(submittedAt, now);
  const remaining = turnaroundHours - elapsed;
  const percentElapsed = (elapsed / turnaroundHours) * 100;

  let status: 'on_track' | 'at_risk' | 'breached';
  if (percentElapsed >= 100) status = 'breached';
  else if (percentElapsed >= 70) status = 'at_risk';
  else status = 'on_track';

  return {
    deadline,
    businessHoursRemaining: Math.max(0, remaining),
    status
  };
}
```

---

### 3.5 Email Queue & Rate Limiting

**Resend free tier: 3,000 emails/month (100/day)**

```typescript
// lib/email/queue.ts
import { createClient } from '@/lib/supabase/server';

export interface EmailJob {
  id: string;
  to: string;
  subject: string;
  template: string;
  data: Record<string, any>;
  priority: 'high' | 'normal' | 'low';
  status: 'pending' | 'sent' | 'failed';
  attempts: number;
  scheduled_at?: Date;
  sent_at?: Date;
  error?: string;
}

// Database table for email queue
CREATE TABLE email_queue (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  to TEXT NOT NULL,
  subject TEXT NOT NULL,
  template TEXT NOT NULL,
  data JSONB NOT NULL,
  priority TEXT DEFAULT 'normal',
  status TEXT DEFAULT 'pending',
  attempts INTEGER DEFAULT 0,
  scheduled_at TIMESTAMPTZ,
  sent_at TIMESTAMPTZ,
  error TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_email_queue_status ON email_queue(status);
CREATE INDEX idx_email_queue_scheduled ON email_queue(scheduled_at);

// Add email to queue
export async function queueEmail(
  to: string,
  subject: string,
  template: string,
  data: Record<string, any>,
  options: {
    priority?: 'high' | 'normal' | 'low';
    scheduledAt?: Date;
  } = {}
): Promise<void> {
  const supabase = await createClient();

  await supabase.from('email_queue').insert({
    to,
    subject,
    template,
    data,
    priority: options.priority || 'normal',
    scheduled_at: options.scheduledAt?.toISOString()
  });
}

// Process email queue (run via cron every 5 minutes)
export async function processEmailQueue() {
  const supabase = await createClient();

  // Check daily limit
  const { count: sentToday } = await supabase
    .from('email_queue')
    .select('*', { count: 'exact', head: true })
    .eq('status', 'sent')
    .gte('sent_at', new Date().toISOString().split('T')[0]);

  if (sentToday && sentToday >= 100) {
    console.log('Daily email limit reached (100/day)');
    return;
  }

  const batchSize = Math.min(10, 100 - (sentToday || 0));

  // Fetch pending emails (prioritized)
  const { data: emails } = await supabase
    .from('email_queue')
    .select('*')
    .eq('status', 'pending')
    .lte('scheduled_at', new Date().toISOString())
    .order('priority', { ascending: false })
    .order('created_at', { ascending: true })
    .limit(batchSize);

  if (!emails || emails.length === 0) return;

  // Send emails
  for (const email of emails) {
    try {
      await sendEmail(email.to, email.subject, email.template, email.data);

      await supabase
        .from('email_queue')
        .update({ status: 'sent', sent_at: new Date().toISOString() })
        .eq('id', email.id);
    } catch (error) {
      await supabase
        .from('email_queue')
        .update({
          status: email.attempts >= 3 ? 'failed' : 'pending',
          attempts: email.attempts + 1,
          error: error.message
        })
        .eq('id', email.id);
    }
  }
}

// Resend integration
async function sendEmail(
  to: string,
  subject: string,
  template: string,
  data: Record<string, any>
) {
  const response = await fetch('https://api.resend.com/emails', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.RESEND_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      from: 'Tasheel <noreply@tasheel.ps>',
      to,
      subject,
      html: renderTemplate(template, data)
    })
  });

  if (!response.ok) {
    throw new Error(`Email failed: ${response.statusText}`);
  }
}
```

---

### 3.6 i18n URL Routing Configuration

**next-intl routing setup:**

```typescript
// middleware.ts
import createMiddleware from 'next-intl/middleware';
import { locales, defaultLocale } from './lib/config/i18n';

export default createMiddleware({
  locales: ['en', 'ar'],
  defaultLocale: 'ar',
  localePrefix: 'as-needed', // Only add /en prefix, Arabic is default
  localeDetection: true
});

export const config = {
  matcher: ['/((?!api|_next|.*\\..*).*)']
};

// lib/config/i18n.ts
export const locales = ['ar', 'en'] as const;
export const defaultLocale = 'ar';

// URL Structure Examples:
// Arabic (default): https://tasheel.ps/services
// English:          https://tasheel.ps/en/services
// Arabic service:   https://tasheel.ps/services/translation-document
// English service:  https://tasheel.ps/en/services/translation-document

// app/[locale]/layout.tsx
import { NextIntlClientProvider } from 'next-intl';
import { getMessages } from 'next-intl/server';

export default async function LocaleLayout({
  children,
  params: { locale }
}: {
  children: React.Node;
  params: { locale: string };
}) {
  const messages = await getMessages();

  return (
    <html lang={locale} dir={locale === 'ar' ? 'rtl' : 'ltr'}>
      <body>
        <NextIntlClientProvider messages={messages}>
          {children}
        </NextIntlClientProvider>
      </body>
    </html>
  );
}

// Navigation helper
import { useLocale } from 'next-intl';
import { useRouter, usePathname } from 'next/navigation';

export function useLocalizedNavigation() {
  const locale = useLocale();
  const router = useRouter();
  const pathname = usePathname();

  const navigate = (path: string) => {
    const localizedPath = locale === 'ar' ? path : `/en${path}`;
    router.push(localizedPath);
  };

  const switchLocale = (newLocale: string) => {
    const pathWithoutLocale = pathname.replace(/^\/(en|ar)/, '');
    const newPath = newLocale === 'ar' ? pathWithoutLocale : `/en${pathWithoutLocale}`;
    router.push(newPath);
  };

  return { navigate, switchLocale, locale };
}
```

---

### 3.7 Webhook Signature Verification

**Payment gateway security (PalPay/PayTabs):**

```typescript
// app/api/webhooks/payment/route.ts
import { createHmac } from 'crypto';
import { headers } from 'next/headers';

export async function POST(request: Request) {
  const headersList = headers();
  const signature = headersList.get('x-webhook-signature');
  const body = await request.text();

  // Verify webhook signature
  const isValid = verifyWebhookSignature(body, signature);

  if (!isValid) {
    return new Response('Invalid signature', { status: 401 });
  }

  const payload = JSON.parse(body);

  // Process payment
  if (payload.status === 'paid') {
    await handleSuccessfulPayment(payload);
  }

  return new Response('OK', { status: 200 });
}

function verifyWebhookSignature(
  payload: string,
  signature: string | null
): boolean {
  if (!signature) return false;

  const secret = process.env.PAYMENT_WEBHOOK_SECRET!;

  const expectedSignature = createHmac('sha256', secret)
    .update(payload)
    .digest('hex');

  return signature === expectedSignature;
}

async function handleSuccessfulPayment(payload: any) {
  const supabase = await createClient();

  // Update application payment status
  const { error } = await supabase
    .from('applications')
    .update({
      payment_status: 'paid',
      payment_date: new Date().toISOString(),
      transaction_id: payload.transaction_id
    })
    .eq('id', payload.metadata.application_id);

  if (error) throw error;

  // Queue confirmation email
  await queueEmail(
    payload.customer_email,
    'Payment Confirmed',
    'payment-confirmation',
    {
      order_number: payload.metadata.order_number,
      amount: payload.amount
    },
    { priority: 'high' }
  );
}
```

---

## 4. Security & Performance

### 4.1 Complete RLS Policies

**Row Level Security for all tables:**

```sql
-- Enable RLS on all tables
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE applications ENABLE ROW LEVEL SECURITY;
ALTER TABLE quotes ENABLE ROW LEVEL SECURITY;
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE files ENABLE ROW LEVEL SECURITY;
ALTER TABLE invoices ENABLE ROW LEVEL SECURITY;

-- Customers table policies
CREATE POLICY "Customers can view their own profile"
ON customers FOR SELECT
TO authenticated
USING (auth.uid() = id);

CREATE POLICY "Customers can update their own profile"
ON customers FOR UPDATE
TO authenticated
USING (auth.uid() = id)
WITH CHECK (auth.uid() = id);

-- Applications table policies
CREATE POLICY "Customers can view their own applications"
ON applications FOR SELECT
TO authenticated
USING (
  customer_id = auth.uid() OR
  auth.uid() IN (SELECT id FROM users WHERE role IN ('admin', 'supervisor', 'officer', 'intake', 'auditor'))
);

CREATE POLICY "Customers can create applications"
ON applications FOR INSERT
TO authenticated
WITH CHECK (customer_id = auth.uid());

CREATE POLICY "Team can update applications"
ON applications FOR UPDATE
TO authenticated
USING (auth.uid() IN (SELECT id FROM users WHERE role IN ('admin', 'supervisor', 'officer', 'intake')))
WITH CHECK (auth.uid() IN (SELECT id FROM users WHERE role IN ('admin', 'supervisor', 'officer', 'intake')));

-- Tasks table policies
CREATE POLICY "Team can view all tasks"
ON tasks FOR SELECT
TO authenticated
USING (auth.uid() IN (SELECT id FROM users WHERE role IN ('admin', 'supervisor', 'officer', 'intake', 'auditor')));

CREATE POLICY "Team can create tasks"
ON tasks FOR INSERT
TO authenticated
WITH CHECK (auth.uid() IN (SELECT id FROM users WHERE role IN ('admin', 'supervisor', 'officer', 'intake')));

CREATE POLICY "Assigned users can update their tasks"
ON tasks FOR UPDATE
TO authenticated
USING (
  assigned_to = auth.uid() OR
  auth.uid() IN (SELECT id FROM users WHERE role IN ('admin', 'supervisor'))
);

-- Files table policies
CREATE POLICY "Customers can view files for their applications"
ON files FOR SELECT
TO authenticated
USING (
  application_id IN (SELECT id FROM applications WHERE customer_id = auth.uid()) OR
  auth.uid() IN (SELECT id FROM users WHERE role IN ('admin', 'supervisor', 'officer', 'intake', 'auditor'))
);

CREATE POLICY "Customers can upload files to their applications"
ON files FOR INSERT
TO authenticated
WITH CHECK (
  uploaded_by = auth.uid() AND
  application_id IN (SELECT id FROM applications WHERE customer_id = auth.uid())
);

CREATE POLICY "Team can upload files"
ON files FOR INSERT
TO authenticated
WITH CHECK (
  uploaded_by = auth.uid() AND
  auth.uid() IN (SELECT id FROM users WHERE role IN ('admin', 'supervisor', 'officer', 'intake'))
);

-- Invoices table policies
CREATE POLICY "Customers can view their invoices"
ON invoices FOR SELECT
TO authenticated
USING (
  application_id IN (SELECT id FROM applications WHERE customer_id = auth.uid()) OR
  auth.uid() IN (SELECT id FROM users WHERE role IN ('admin', 'supervisor', 'auditor'))
);

-- Audit logs (view-only for auditors)
CREATE POLICY "Auditors can view audit logs"
ON audit_logs FOR SELECT
TO authenticated
USING (auth.uid() IN (SELECT id FROM users WHERE role = 'auditor'));
```

---

### 4.2 Database Indexes for Performance

```sql
-- Applications table indexes
CREATE INDEX idx_applications_customer_id ON applications(customer_id);
CREATE INDEX idx_applications_service_id ON applications(service_id);
CREATE INDEX idx_applications_assigned_to ON applications(assigned_to);
CREATE INDEX idx_applications_status ON applications(status);
CREATE INDEX idx_applications_submitted_at ON applications(submitted_at DESC);
CREATE INDEX idx_applications_order_number ON applications(order_number);

-- Composite index for dashboard queries
CREATE INDEX idx_applications_status_assigned ON applications(status, assigned_to);

-- Tasks table indexes
CREATE INDEX idx_tasks_application_id ON tasks(application_id);
CREATE INDEX idx_tasks_assigned_to ON tasks(assigned_to);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_due_date ON tasks(due_date);

-- Composite index for "My Tasks" queries
CREATE INDEX idx_tasks_assigned_status ON tasks(assigned_to, status);

-- Files table indexes
CREATE INDEX idx_files_application_id ON files(application_id);
CREATE INDEX idx_files_uploaded_by ON files(uploaded_by);

-- Messages table indexes
CREATE INDEX idx_messages_application_id ON messages(application_id);
CREATE INDEX idx_messages_created_at ON messages(created_at DESC);

-- Services table indexes
CREATE INDEX idx_services_slug ON services(slug);
CREATE INDEX idx_services_category ON services(category);
CREATE INDEX idx_services_active ON services(is_active);

-- Full-text search index for services
CREATE INDEX idx_services_search ON services USING GIN(to_tsvector('english', name_en || ' ' || description_en));
CREATE INDEX idx_services_search_ar ON services USING GIN(to_tsvector('arabic', name_ar || ' ' || description_ar));
```

---

### 4.3 Error Handling Strategy

**Global error boundaries and API responses:**

```typescript
// app/error.tsx (Global Error Boundary)
'use client';

import { useEffect } from 'react';
import { Button } from '@mui/material';

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    console.error('Application error:', error);
  }, [error]);

  return (
    <div className="flex min-h-screen flex-col items-center justify-center">
      <h2 className="text-2xl font-bold mb-4">Something went wrong!</h2>
      <Button onClick={() => reset()}>Try again</Button>
    </div>
  );
}

// lib/errors.ts (Custom Error Classes)
export class AppError extends Error {
  constructor(
    public message: string,
    public statusCode: number = 500,
    public code?: string
  ) {
    super(message);
    this.name = 'AppError';
  }
}

export class ValidationError extends AppError {
  constructor(message: string, public fields?: Record<string, string>) {
    super(message, 400, 'VALIDATION_ERROR');
    this.name = 'ValidationError';
  }
}

export class AuthenticationError extends AppError {
  constructor(message: string = 'Authentication required') {
    super(message, 401, 'AUTH_ERROR');
    this.name = 'AuthenticationError';
  }
}

export class AuthorizationError extends AppError {
  constructor(message: string = 'Insufficient permissions') {
    super(message, 403, 'AUTHORIZATION_ERROR');
    this.name = 'AuthorizationError';
  }
}

// API error handler middleware
export function handleApiError(error: unknown): Response {
  console.error('API Error:', error);

  if (error instanceof ValidationError) {
    return NextResponse.json(
      {
        error: error.message,
        code: error.code,
        fields: error.fields
      },
      { status: error.statusCode }
    );
  }

  if (error instanceof AppError) {
    return NextResponse.json(
      {
        error: error.message,
        code: error.code
      },
      { status: error.statusCode }
    );
  }

  // Unknown error
  return NextResponse.json(
    {
      error: 'Internal server error',
      code: 'INTERNAL_ERROR'
    },
    { status: 500 }
  );
}

// Usage in API routes
export async function POST(request: Request) {
  try {
    const body = await request.json();

    // Validation
    if (!body.email) {
      throw new ValidationError('Email is required', { email: 'Required field' });
    }

    // Authorization
    const user = await getCurrentUser();
    if (!user) {
      throw new AuthenticationError();
    }

    if (user.role !== 'admin') {
      throw new AuthorizationError('Admin access required');
    }

    // Business logic
    const result = await processRequest(body);

    return NextResponse.json({ data: result });
  } catch (error) {
    return handleApiError(error);
  }
}
```

---

## Phase 1: Launch (Week 1)

**Goal:** Website live, customers can browse services and submit requests

### Features to Build

#### 1.1 Bilingual Setup (next-intl)

**Files:**
- `/locales/en.json` - English translations
- `/locales/ar.json` - Arabic translations
- `/src/i18n.ts` - i18n configuration
- `/middleware.ts` - Locale routing middleware

**Implementation:**
```typescript
// src/i18n.ts
export const locales = ['en', 'ar'] as const;
export const defaultLocale = 'ar' as const;

// middleware.ts
import createMiddleware from 'next-intl/middleware';

export default createMiddleware({
  locales: ['en', 'ar'],
  defaultLocale: 'ar',
  localePrefix: 'as-needed'
});
```

**RTL Support:**
```typescript
// theme.ts - Add direction based on locale
const theme = createTheme({
  direction: locale === 'ar' ? 'rtl' : 'ltr',
  // ...rest of theme
});
```

**Tasks:**
- [ ] Install next-intl
- [ ] Create locale files with ~100 common keys (homepage, navigation, forms, buttons)
- [ ] Configure routing middleware
- [ ] Update theme.ts for RTL
- [ ] Create LanguageSwitcher component
- [ ] Test all pages in both languages

---

#### 1.2 Service Catalog (30 Services)

**Pages:**
- `/[locale]/services` - Services listing page
- `/[locale]/services/[slug]` - Service detail page

**Components:**
- `ServiceCard.tsx` - Card for service listing
- `ServiceGrid.tsx` - Grid of services with filters
- `ServiceDetail.tsx` - Full service page
- `ProcessSteps.tsx` - 4-step visual workflow

**Data:**
```typescript
// src/data/services.ts
export const services: Service[] = [
  {
    id: '1',
    slug: 'driver-license-renewal',
    name_en: 'Driver License Renewal',
    name_ar: 'ØªØ¬Ø¯ÙŠØ¯ Ø±Ø®ØµØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©',
    description_en: 'Renew your Palestinian driver license...',
    description_ar: 'Ø¬Ø¯Ø¯ Ø±Ø®ØµØ© Ù‚ÙŠØ§Ø¯ØªÙƒ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ©...',
    category: 'government',
    price: 150,
    turnaround_days: 5,
    required_documents_en: ['Copy of old license', 'ID copy', 'Medical test'],
    required_documents_ar: ['Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø±Ø®ØµØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©', 'Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©', 'ÙØ­Øµ Ø·Ø¨ÙŠ'],
    process_steps_en: [
      { title: 'Submit Request', description: 'Fill form and upload docs' },
      { title: 'We Process', description: 'Submit to Ministry of Transport' },
      { title: 'Approval', description: 'Await ministry approval' },
      { title: 'Delivery', description: 'Receive your renewed license' }
    ],
    process_steps_ar: [/* Arabic version */]
  },
  // ...29 more services
];
```

**Tasks:**
- [ ] Create service data file with 30 services (client provides details)
- [ ] Use AI to translate descriptions to Arabic
- [ ] Build ServiceGrid with category filters
- [ ] Build ServiceCard component
- [ ] Build ServiceDetail page with dynamic routing
- [ ] Add ProcessSteps visualization
- [ ] Seed services to Supabase

---

#### 1.3 Quote Request Form

**Page:**
- `/[locale]/services/[slug]#request-quote` - Anchor to form on service page

**Component:**
- `QuoteRequestForm.tsx`

**Fields:**
- Customer name (required)
- Email (required)
- Phone (required)
- Service (auto-filled from page)
- Urgency (dropdown: standard/express/urgent)
- Message (textarea)
- File uploads (up to 5 files, 10MB each) - **Phase 2**

**Server Action:**
```typescript
// src/app/actions/submit-quote-request.ts
export async function submitQuoteRequest(data: QuoteRequestData) {
  // 1. Generate order number: TSH-YYYYMMDD-XXX
  const orderNumber = generateOrderNumber();

  // 2. Insert to applications table
  const { data: application } = await supabase
    .from('applications')
    .insert({
      order_number: orderNumber,
      customer_email: data.email,
      customer_name: data.name,
      customer_phone: data.phone,
      service_id: data.serviceId,
      urgency: data.urgency,
      message: data.message,
      status: 'new'
    })
    .select()
    .single();

  // 3. Create application event
  await supabase.from('application_events').insert({
    application_id: application.id,
    event_type: 'submitted',
    notes: 'Customer submitted quote request'
  });

  // 4. Send confirmation email to customer
  await sendQuoteConfirmationEmail(application);

  // 5. Send alert email to admin
  await sendAdminAlertEmail(application);

  return { success: true, orderNumber };
}
```

**Tasks:**
- [ ] Build QuoteRequestForm component
- [ ] Add validation with Zod
- [ ] Create submitQuoteRequest server action
- [ ] Generate order number logic
- [ ] Create email templates (confirmation + admin alert)
- [ ] Test form submission end-to-end

---

#### 1.4 Admin Panel (Basic)

**Route:**
- `/admin/login` - Login page
- `/admin/requests` - Requests list

**Authentication:**
```typescript
// lib/admin-auth.ts
export async function checkAdminAuth() {
  const cookies = require('next/headers').cookies;
  const session = cookies().get('admin_session');

  if (!session) {
    redirect('/admin/login');
  }

  return session.value; // user ID
}
```

**Login API:**
```typescript
// app/api/admin/login/route.ts
export async function POST(request: Request) {
  const { email, password } = await request.json();

  // Check against users table
  const { data: user } = await supabase
    .from('users')
    .select('*')
    .eq('email', email)
    .single();

  if (!user || !bcrypt.compareSync(password, user.password_hash)) {
    return NextResponse.json({ error: 'Invalid credentials' }, { status: 401 });
  }

  // Create session cookie
  cookies().set('admin_session', user.id, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24, // 24 hours
    sameSite: 'lax'
  });

  return NextResponse.json({ success: true });
}
```

**Requests Page:**
```typescript
// app/admin/requests/page.tsx
export default async function RequestsPage() {
  await checkAdminAuth();

  const { data: requests } = await supabase
    .from('applications')
    .select(`
      *,
      services(name_en, name_ar),
      users(name)
    `)
    .order('created_at', { ascending: false });

  return <RequestsTable requests={requests} />;
}
```

**Tasks:**
- [ ] Build login page
- [ ] Create admin auth helpers
- [ ] Build requests table with search/filter
- [ ] Add status dropdown (update via API)
- [ ] Create request detail page
- [ ] Add internal notes field

---

#### 1.5 Email Notifications

**Templates (2 in Phase 1):**

1. **Customer Confirmation**
```typescript
// lib/email-templates/quote-confirmation.ts
export function quoteConfirmationTemplate(data: {
  orderNumber: string;
  customerName: string;
  serviceName: string;
  language: 'ar' | 'en';
}) {
  const subject = data.language === 'ar'
    ? `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø±Ù‚Ù… ${data.orderNumber}`
    : `Request Received: ${data.orderNumber}`;

  const html = `
    <html dir="${data.language === 'ar' ? 'rtl' : 'ltr'}">
      <body>
        <h1>${data.language === 'ar' ? 'Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ' : 'Thank You'}</h1>
        <p>
          ${data.language === 'ar'
            ? `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${data.orderNumber}`
            : `Your request has been received. Order #: ${data.orderNumber}`
          }
        </p>
        <p>
          ${data.language === 'ar'
            ? `Ø§Ù„Ø®Ø¯Ù…Ø©: ${data.serviceName}`
            : `Service: ${data.serviceName}`
          }
        </p>
        <p>
          <a href="${process.env.NEXT_PUBLIC_SITE_URL}/track?order=${data.orderNumber}">
            ${data.language === 'ar' ? 'ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ' : 'Track Your Order'}
          </a>
        </p>
      </body>
    </html>
  `;

  return { subject, html };
}
```

2. **Admin Alert**
```typescript
export function adminAlertTemplate(data: Application) {
  return {
    subject: `New Quote Request: ${data.order_number}`,
    html: `
      <h2>New Quote Request</h2>
      <p><strong>Order:</strong> ${data.order_number}</p>
      <p><strong>Customer:</strong> ${data.customer_name} (${data.customer_email})</p>
      <p><strong>Service:</strong> ${data.service.name_en}</p>
      <p><strong>Urgency:</strong> ${data.urgency}</p>
      <p><a href="${process.env.NEXT_PUBLIC_SITE_URL}/admin/requests/${data.id}">View in Admin Panel</a></p>
    `
  };
}
```

**Send Function:**
```typescript
// lib/email.ts
import { Resend } from 'resend';
const resend = new Resend(process.env.RESEND_API_KEY);

export async function sendEmail({
  to,
  subject,
  html
}: {
  to: string;
  subject: string;
  html: string;
}) {
  await resend.emails.send({
    from: `${process.env.CONTACT_NAME} <${process.env.CONTACT_EMAIL}>`,
    to,
    subject,
    html
  });
}
```

**Tasks:**
- [ ] Set up Resend account
- [ ] Create email templates (bilingual)
- [ ] Test email sending
- [ ] Add email to quote submission flow

---

### Phase 1 Deployment Checklist

- [ ] All pages render in Arabic and English
- [ ] 30 services visible in catalog
- [ ] Quote form works and sends emails
- [ ] Admin can login and see requests
- [ ] Mobile responsive
- [ ] Deploy to Netlify
- [ ] Connect custom domain
- [ ] SSL certificate active

---

## Phase 2: Customers & Payments (Week 2)

**Goal:** Customers can login, pay online, track orders

### Features to Build

#### 2.1 Customer Authentication

**Setup Supabase Auth:**
```typescript
// lib/supabase-client.ts
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';

export const supabase = createClientComponentClient();
```

**Register Page:**
```typescript
// app/[locale]/register/page.tsx
'use client';
export default function RegisterPage() {
  async function handleRegister(email: string, password: string, name: string) {
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: { name }
      }
    });

    if (!error) {
      // Create customer record
      await supabase.from('customers').insert({
        id: data.user.id,
        email,
        name
      });

      router.push('/dashboard');
    }
  }

  return <RegisterForm onSubmit={handleRegister} />;
}
```

**Login Page:**
```typescript
// app/[locale]/login/page.tsx
async function handleLogin(email: string, password: string) {
  const { error } = await supabase.auth.signInWithPassword({
    email,
    password
  });

  if (!error) router.push('/dashboard');
}
```

**Tasks:**
- [ ] Enable Supabase Auth email provider
- [ ] Build register page
- [ ] Build login page
- [ ] Build password reset flow
- [ ] Add auth state provider
- [ ] Protect /dashboard routes

---

#### 2.2 Customer Dashboard

**Route:** `/[locale]/dashboard`

**Layout:**
```typescript
// app/[locale]/dashboard/layout.tsx
export default async function DashboardLayout({ children }) {
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) redirect('/login');

  return (
    <div className="dashboard-layout">
      <Sidebar user={user} />
      <main>{children}</main>
    </div>
  );
}
```

**My Requests Page:**
```typescript
// app/[locale]/dashboard/requests/page.tsx
export default async function MyRequestsPage() {
  const { data: { user } } = await supabase.auth.getUser();

  const { data: requests } = await supabase
    .from('applications')
    .select(`
      *,
      services(name_en, name_ar),
      invoices(amount, status)
    `)
    .eq('customer_id', user.id)
    .order('created_at', { ascending: false });

  return <RequestsTable requests={requests} />;
}
```

**Request Detail Page:**
```typescript
// app/[locale]/dashboard/requests/[id]/page.tsx
export default async function RequestDetailPage({ params }) {
  const { data: { user } } = await supabase.auth.getUser();

  const { data: request } = await supabase
    .from('applications')
    .select(`
      *,
      services(*),
      application_events(event_type, notes, created_at),
      files(*),
      invoices(*)
    `)
    .eq('id', params.id)
    .eq('customer_id', user.id) // security check
    .single();

  return (
    <div>
      <RequestStatus status={request.status} />
      <Timeline events={request.application_events} />
      <FilesList files={request.files} />
      {request.invoices[0] && <Invoice invoice={request.invoices[0]} />}
    </div>
  );
}
```

**Tasks:**
- [ ] Build dashboard layout
- [ ] Build requests list page
- [ ] Build request detail page
- [ ] Add status timeline component
- [ ] Add file upload/download

---

#### 2.3 File Upload & Storage

**Supabase Storage Setup:**
```bash
# Create buckets
- customer-uploads (private)
- completed-files (private)
```

**Upload Component:**
```typescript
// components/FileUpload.tsx
'use client';
export function FileUpload({ applicationId }: { applicationId: string }) {
  async function handleUpload(file: File) {
    // 1. Upload to Supabase Storage
    const filePath = `${applicationId}/${Date.now()}-${file.name}`;
    const { error: uploadError } = await supabase.storage
      .from('customer-uploads')
      .upload(filePath, file);

    if (uploadError) throw uploadError;

    // 2. Create file record
    await supabase.from('files').insert({
      application_id: applicationId,
      filename: file.name,
      file_path: filePath,
      file_size: file.size,
      file_type: file.type,
      is_customer_upload: true
    });
  }

  return <input type="file" onChange={(e) => handleUpload(e.target.files[0])} />;
}
```

**Download:**
```typescript
async function downloadFile(filePath: string) {
  const { data } = await supabase.storage
    .from('customer-uploads')
    .createSignedUrl(filePath, 3600); // 1 hour expiry

  window.open(data.signedUrl);
}
```

**Tasks:**
- [ ] Create Supabase Storage buckets
- [ ] Build FileUpload component
- [ ] Add file upload to quote form
- [ ] Build file list component
- [ ] Add download functionality
- [ ] Set file size limits (10MB)

---

#### 2.4 Payment Integration

**Choose Gateway:** PalPay OR PayTabs (client decides)

**Example: Generic Implementation**

```typescript
// lib/payment.ts
export async function createPaymentSession({
  amount,
  currency = 'ILS',
  orderId,
  customerEmail
}: PaymentSessionParams) {
  const response = await fetch('https://gateway.example.com/create-session', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.PAYMENT_GATEWAY_SECRET_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      amount,
      currency,
      metadata: { orderId },
      customer_email: customerEmail,
      success_url: `${process.env.NEXT_PUBLIC_SITE_URL}/payment/success?order=${orderId}`,
      cancel_url: `${process.env.NEXT_PUBLIC_SITE_URL}/payment/cancel?order=${orderId}`
    })
  });

  const { session_url } = await response.json();
  return session_url;
}
```

**Admin Creates Invoice:**
```typescript
// app/api/admin/invoices/route.ts
export async function POST(request: Request) {
  const { applicationId, amount } = await request.json();

  // 1. Create invoice
  const invoiceNumber = generateInvoiceNumber(); // "INV-20250115-001"
  const { data: invoice } = await supabase
    .from('invoices')
    .insert({
      application_id: applicationId,
      invoice_number: invoiceNumber,
      amount,
      status: 'pending'
    })
    .select()
    .single();

  // 2. Create payment session
  const paymentUrl = await createPaymentSession({
    amount,
    orderId: invoice.id,
    customerEmail: application.customer_email
  });

  // 3. Update invoice with payment link
  await supabase
    .from('invoices')
    .update({ payment_link: paymentUrl })
    .eq('id', invoice.id);

  // 4. Send email to customer
  await sendPaymentLinkEmail({
    to: application.customer_email,
    paymentUrl,
    amount,
    invoiceNumber
  });

  return NextResponse.json({ success: true });
}
```

**Webhook Handler:**
```typescript
// app/api/webhooks/payment/route.ts
export async function POST(request: Request) {
  const payload = await request.json();

  // Verify webhook signature
  const signature = request.headers.get('x-gateway-signature');
  if (!verifySignature(payload, signature)) {
    return NextResponse.json({ error: 'Invalid signature' }, { status: 401 });
  }

  // Update invoice status
  const { invoice_id, status } = payload;
  await supabase
    .from('invoices')
    .update({
      status: status === 'succeeded' ? 'paid' : 'failed',
      paid_at: status === 'succeeded' ? new Date().toISOString() : null
    })
    .eq('id', invoice_id);

  // Create payment record
  await supabase.from('payments').insert({
    invoice_id,
    gateway: 'palpal',
    transaction_id: payload.transaction_id,
    amount: payload.amount,
    status: status === 'succeeded' ? 'completed' : 'failed',
    gateway_response: payload
  });

  // Send confirmation email if paid
  if (status === 'succeeded') {
    await sendPaymentConfirmationEmail(invoice_id);
  }

  return NextResponse.json({ received: true });
}
```

**Tasks:**
- [ ] Set up payment gateway account (sandbox)
- [ ] Implement createPaymentSession
- [ ] Build invoice creation API
- [ ] Build webhook handler
- [ ] Test payment flow end-to-end
- [ ] Add payment link to admin panel
- [ ] Send payment emails

---

#### 2.5 Invoice PDF Generation

**Using react-pdf:**

```typescript
// lib/generate-invoice-pdf.ts
import { PDFDocument } from 'pdf-lib';

export async function generateInvoicePDF(invoice: Invoice, language: 'ar' | 'en') {
  const doc = await PDFDocument.create();
  const page = doc.addPage([595, 842]); // A4 size

  // Add logo
  // Add invoice number, date
  // Add customer info
  // Add service details
  // Add amount

  const pdfBytes = await doc.save();
  return Buffer.from(pdfBytes);
}
```

**Store PDF:**
```typescript
async function createInvoicePDF(invoiceId: string) {
  const invoice = await getInvoice(invoiceId);
  const pdfBuffer = await generateInvoicePDF(invoice, 'ar');

  // Upload to Supabase Storage
  const { data } = await supabase.storage
    .from('invoices')
    .upload(`${invoiceId}.pdf`, pdfBuffer, {
      contentType: 'application/pdf'
    });

  return data.path;
}
```

**Tasks:**
- [ ] Design invoice template (Figma or sketch)
- [ ] Implement PDF generation
- [ ] Add company logo/branding
- [ ] Support bilingual invoices
- [ ] Add download button to customer dashboard

---

#### 2.6 Email Notifications (4 more types)

3. **Status Changed**
4. **Payment Link Sent**
5. **Payment Received**
6. **Request Completed**

**Tasks:**
- [ ] Create 4 more email templates (bilingual)
- [ ] Wire up to status change events
- [ ] Wire up to payment events
- [ ] Test all email flows

---

### Phase 2 Deployment Checklist

- [ ] Customers can register/login
- [ ] Customer dashboard shows their requests
- [ ] File upload/download works
- [ ] Payment flow works (test with sandbox)
- [ ] Invoices generate correctly
- [ ] All 6 email types working
- [ ] Deploy to Netlify
- [ ] Test end-to-end customer journey

---

## Phase 3: Team & All Services (Weeks 3-4)

**Goal:** Full team operations, all 149 services, task management, SLA tracking

### Features to Build

#### 3.1 Service Catalog Expansion

**Tasks:**
- [ ] Add 119 more services to database (client provides data)
- [ ] Use AI to translate descriptions
- [ ] Organize by ministry/category
- [ ] Add advanced filters (price, turnaround, ministry)
- [ ] Add service search (full-text)
- [ ] Test all 149 service pages

---

#### 3.2 Role-Based Access Control (5 Roles)

**Update users table:**
```sql
ALTER TABLE users ADD COLUMN role TEXT DEFAULT 'officer';
-- Roles: 'admin', 'supervisor', 'officer', 'intake', 'auditor'

ALTER TABLE users ADD COLUMN permissions JSONB;
```

**Permission Matrix:**
```typescript
// lib/permissions.ts
export const PERMISSIONS = {
  admin: {
    view_all_requests: true,
    edit_all_requests: true,
    assign_requests: true,
    manage_users: true,
    view_financials: true,
    delete_requests: true
  },
  supervisor: {
    view_all_requests: true,
    edit_all_requests: true,
    assign_requests: true,
    manage_users: false,
    view_financials: true,
    delete_requests: false
  },
  officer: {
    view_all_requests: false, // only assigned
    edit_all_requests: false, // only assigned
    assign_requests: false,
    manage_users: false,
    view_financials: false,
    delete_requests: false
  },
  intake: {
    view_all_requests: false, // only new/unassigned
    edit_all_requests: false,
    assign_requests: true, // can assign to officers
    manage_users: false,
    view_financials: false,
    delete_requests: false
  },
  auditor: {
    view_all_requests: true, // read-only
    edit_all_requests: false,
    assign_requests: false,
    manage_users: false,
    view_financials: true, // read-only
    delete_requests: false
  }
};

export function can(user: User, permission: string): boolean {
  return PERMISSIONS[user.role]?.[permission] || false;
}
```

**Row Level Security (RLS):**
```sql
-- Officers can only see their assigned requests
CREATE POLICY "Officers see assigned requests"
ON applications FOR SELECT
USING (
  auth.uid() IN (
    SELECT id FROM users WHERE role = 'officer'
  )
  AND assigned_to = auth.uid()
);

-- Supervisors see all
CREATE POLICY "Supervisors see all requests"
ON applications FOR SELECT
USING (
  auth.uid() IN (
    SELECT id FROM users WHERE role IN ('supervisor', 'admin')
  )
);

-- Auditors see all (read-only)
CREATE POLICY "Auditors see all requests"
ON applications FOR SELECT
USING (
  auth.uid() IN (
    SELECT id FROM users WHERE role = 'auditor'
  )
);
```

**Tasks:**
- [ ] Update users table schema
- [ ] Create permission system
- [ ] Implement RLS policies
- [ ] Build user management page (admin only)
- [ ] Add role dropdown to request assign
- [ ] Test permissions enforcement

---

#### 3.3 Task Management System

**Tasks Table:** (see schema above)

**Create Task:**
```typescript
// app/api/tasks/route.ts
export async function POST(request: Request) {
  const user = await getAuthUser();
  const { applicationId, title, type, assignedTo, dueDate, priority } = await request.json();

  const { data: task } = await supabase
    .from('tasks')
    .insert({
      application_id: applicationId,
      title,
      type,
      assigned_to: assignedTo,
      created_by: user.id,
      due_date: dueDate,
      priority,
      status: 'open'
    })
    .select()
    .single();

  // Send notification to assignee
  await sendTaskAssignmentEmail(task);

  return NextResponse.json(task);
}
```

**My Tasks Page:**
```typescript
// app/[locale]/admin/tasks/page.tsx
export default async function MyTasksPage() {
  const user = await getAuthUser();

  const { data: tasks } = await supabase
    .from('tasks')
    .select(`
      *,
      applications(order_number, customer_name, services(name_en, name_ar))
    `)
    .eq('assigned_to', user.id)
    .order('due_date', { ascending: true });

  return <TasksList tasks={tasks} />;
}
```

**Tasks:**
- [ ] Build task creation form
- [ ] Build My Tasks page
- [ ] Add task list to request detail page
- [ ] Add task status update
- [ ] Add time tracking field
- [ ] Build overdue tasks view

---

#### 3.4 Custom Workflow Pipelines

**Service Pipelines:**
```typescript
// lib/pipelines.ts
export const PIPELINES = {
  translation: [
    { key: 'new', label_en: 'New', label_ar: 'Ø¬Ø¯ÙŠØ¯' },
    { key: 'screening', label_en: 'Screening', label_ar: 'ÙØ­Øµ' },
    { key: 'in_process', label_en: 'In Process', label_ar: 'Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„' },
    { key: 'qa_review', label_en: 'QA Review', label_ar: 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©' },
    { key: 'ready', label_en: 'Ready', label_ar: 'Ø¬Ø§Ù‡Ø²' },
    { key: 'delivered', label_en: 'Delivered', label_ar: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' },
    { key: 'closed', label_en: 'Closed', label_ar: 'Ù…ØºÙ„Ù‚' }
  ],
  government: [
    { key: 'new', label_en: 'New', label_ar: 'Ø¬Ø¯ÙŠØ¯' },
    { key: 'screening', label_en: 'Screening', label_ar: 'ÙØ­Øµ' },
    { key: 'in_process', label_en: 'In Process', label_ar: 'Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„' },
    { key: 'submitted_to_ministry', label_en: 'Submitted to Ministry', label_ar: 'Ù…Ù‚Ø¯Ù… Ù„Ù„ÙˆØ²Ø§Ø±Ø©' },
    { key: 'pending_feedback', label_en: 'Pending Feedback', label_ar: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¯' },
    { key: 'ready', label_en: 'Ready', label_ar: 'Ø¬Ø§Ù‡Ø²' },
    { key: 'delivered', label_en: 'Delivered', label_ar: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' },
    { key: 'closed', label_en: 'Closed', label_ar: 'Ù…ØºÙ„Ù‚' }
  ],
  business: [
    { key: 'new', label_en: 'New', label_ar: 'Ø¬Ø¯ÙŠØ¯' },
    { key: 'screening', label_en: 'Screening', label_ar: 'ÙØ­Øµ' },
    { key: 'document_prep', label_en: 'Document Prep', label_ar: 'ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª' },
    { key: 'submitted', label_en: 'Submitted', label_ar: 'Ù…Ù‚Ø¯Ù…' },
    { key: 'pending_approval', label_en: 'Pending Approval', label_ar: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' },
    { key: 'ready', label_en: 'Ready', label_ar: 'Ø¬Ø§Ù‡Ø²' },
    { key: 'delivered', label_en: 'Delivered', label_ar: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' },
    { key: 'closed', label_en: 'Closed', label_ar: 'Ù…ØºÙ„Ù‚' }
  ]
};

export function getPipelineForService(serviceCategory: string) {
  if (serviceCategory === 'translation') return PIPELINES.translation;
  if (serviceCategory === 'government') return PIPELINES.government;
  if (serviceCategory === 'business') return PIPELINES.business;
  return PIPELINES.government; // default
}
```

**Update services table:**
```sql
ALTER TABLE services ADD COLUMN pipeline_type TEXT DEFAULT 'government';
-- 'translation', 'government', 'business'
```

**Tasks:**
- [ ] Add pipeline_type to services
- [ ] Build pipeline configuration
- [ ] Update status dropdown to show pipeline stages
- [ ] Build visual pipeline progress bar
- [ ] Test status transitions

---

#### 3.5 SLA Tracking

**SLA Configs Table:** (see schema)

**Seed SLA configs:**
```sql
INSERT INTO sla_configs (service_id, target_hours, warning_threshold_percent)
SELECT
  id,
  turnaround_days * 8 as target_hours, -- convert days to business hours (8hr/day)
  70
FROM services;
```

**Calculate SLA:**
```typescript
// lib/sla.ts
export function calculateSLA(application: Application, slaConfig: SLAConfig) {
  const now = new Date();
  const submitted = new Date(application.submitted_at);

  // Calculate business hours elapsed (skip weekends Friday/Saturday)
  const hoursElapsed = calculateBusinessHours(submitted, now);

  const targetHours = slaConfig.target_hours;
  const percentElapsed = (hoursElapsed / targetHours) * 100;

  return {
    hoursElapsed,
    targetHours,
    percentElapsed,
    status: percentElapsed >= 100 ? 'breached' :
            percentElapsed >= slaConfig.warning_threshold_percent ? 'at_risk' :
            'on_track',
    hoursRemaining: Math.max(0, targetHours - hoursElapsed)
  };
}

function calculateBusinessHours(start: Date, end: Date): number {
  let hours = 0;
  let current = new Date(start);

  while (current < end) {
    const day = current.getDay();
    // Skip Friday (5) and Saturday (6) for Palestine
    if (day !== 5 && day !== 6) {
      hours++;
    }
    current.setHours(current.getHours() + 1);
  }

  return hours;
}
```

**Display SLA:**
```typescript
// components/SLABadge.tsx
export function SLABadge({ application }: { application: Application }) {
  const sla = calculateSLA(application, application.sla_config);

  const color = sla.status === 'breached' ? 'error' :
                sla.status === 'at_risk' ? 'warning' :
                'success';

  return (
    <Chip
      label={`${sla.hoursRemaining}h remaining`}
      color={color}
      size="small"
    />
  );
}
```

**Tasks:**
- [ ] Seed SLA configs for all services
- [ ] Implement business hours calculation
- [ ] Build SLA calculation function
- [ ] Add SLA badge to request list
- [ ] Add SLA countdown to request detail
- [ ] Build SLA report page

---

#### 3.6 Team Dashboards

**Admin Dashboard:**
```typescript
// app/[locale]/admin/dashboard/page.tsx
export default async function AdminDashboard() {
  const user = await getAuthUser();

  // Get metrics
  const totalRevenue = await getTotalRevenue();
  const revenueThisMonth = await getRevenueThisMonth();
  const totalRequests = await getTotalRequests();
  const pendingRequests = await getPendingRequests();

  // Get chart data
  const requestsOverTime = await getRequestsOverTime(30); // last 30 days
  const statusDistribution = await getStatusDistribution();
  const topServices = await getTopServices(5);

  return (
    <Grid container spacing={3}>
      <Grid item xs={12} md={3}>
        <StatsCard title="Total Revenue" value={`â‚ª${totalRevenue}`} />
      </Grid>
      <Grid item xs={12} md={3}>
        <StatsCard title="Revenue This Month" value={`â‚ª${revenueThisMonth}`} />
      </Grid>
      <Grid item xs={12} md={3}>
        <StatsCard title="Total Requests" value={totalRequests} />
      </Grid>
      <Grid item xs={12} md={3}>
        <StatsCard title="Pending" value={pendingRequests} />
      </Grid>

      <Grid item xs={12} md={8}>
        <Card>
          <CardHeader title="Requests Over Time" />
          <CardContent>
            <LineChart data={requestsOverTime} />
          </CardContent>
        </Card>
      </Grid>

      <Grid item xs={12} md={4}>
        <Card>
          <CardHeader title="Status Distribution" />
          <CardContent>
            <PieChart data={statusDistribution} />
          </CardContent>
        </Card>
      </Grid>

      <Grid item xs={12}>
        <Card>
          <CardHeader title="Top Services" />
          <CardContent>
            <BarChart data={topServices} />
          </CardContent>
        </Card>
      </Grid>
    </Grid>
  );
}
```

**Tasks:**
- [ ] Build metric calculation functions
- [ ] Build StatsCard component
- [ ] Build LineChart component (Recharts)
- [ ] Build PieChart component
- [ ] Build BarChart component
- [ ] Build admin dashboard page
- [ ] Build supervisor dashboard (different metrics)
- [ ] Build officer dashboard (my stats)

---

### Phase 3 Deployment Checklist

- [ ] All 149 services in database
- [ ] 5 roles working with correct permissions
- [ ] Task creation and assignment works
- [ ] SLA tracking shows correct countdowns
- [ ] Dashboards render with real data
- [ ] Test with multiple users (different roles)
- [ ] Deploy to Netlify

---

## Phase 4: Automation (Week 5)

**Goal:** Automation rules, advanced analytics, kanban, exports

### Features to Build

#### 4.1 Auto-Create Tasks

**Automation Rules:**
```typescript
// lib/automation/auto-create-tasks.ts
export async function onStatusChange(
  applicationId: string,
  oldStatus: string,
  newStatus: string
) {
  const application = await getApplication(applicationId);

  // Rule 1: Status â†’ Screening
  if (newStatus === 'screening' && application.service.category === 'translation') {
    await createTask({
      application_id: applicationId,
      title: 'Verify document quality and page count',
      type: 'qa',
      assigned_to: await getIntakeSpecialist(),
      due_date: addBusinessDays(new Date(), 1),
      priority: 'normal'
    });

    await logAutomation('task_created', applicationId);
  }

  // Rule 2: Status â†’ Submitted to Ministry
  if (newStatus === 'submitted_to_ministry') {
    await createTask({
      application_id: applicationId,
      title: 'Follow up with ministry on submission status',
      type: 'ministry',
      assigned_to: application.assigned_to,
      due_date: addBusinessDays(new Date(), 3),
      priority: 'normal'
    });

    await logAutomation('task_created', applicationId);
  }

  // Rule 3: Status â†’ QA Review
  if (newStatus === 'qa_review') {
    await createTask({
      application_id: applicationId,
      title: 'Quality check translation/documents',
      type: 'qa',
      assigned_to: await getSupervisor(),
      due_date: addBusinessDays(new Date(), 1),
      priority: 'high'
    });

    await logAutomation('task_created', applicationId);
  }
}
```

**Hook into Status Change:**
```typescript
// app/api/applications/[id]/status/route.ts
export async function PATCH(request: Request, { params }) {
  const { status, notes } = await request.json();
  const user = await getAuthUser();

  // Get current status
  const { data: application } = await supabase
    .from('applications')
    .select('status')
    .eq('id', params.id)
    .single();

  const oldStatus = application.status;

  // Update status
  await supabase
    .from('applications')
    .update({ status, updated_at: new Date().toISOString() })
    .eq('id', params.id);

  // Log event
  await supabase.from('application_events').insert({
    application_id: params.id,
    event_type: 'status_changed',
    user_id: user.id,
    notes,
    data: { from: oldStatus, to: status }
  });

  // Send email to customer
  await sendStatusChangeEmail(params.id, status);

  // AUTOMATION: Auto-create tasks
  await onStatusChange(params.id, oldStatus, status);

  return NextResponse.json({ success: true });
}
```

**Tasks:**
- [ ] Implement auto-create task rules
- [ ] Hook into status change API
- [ ] Test each rule triggers correctly
- [ ] Log automation in automation_logs table

---

#### 4.2 Daily Digest Emails

**Cron Job Setup:**
```typescript
// app/api/cron/daily-digest/route.ts
export async function GET(request: Request) {
  // Verify cron secret
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return new Response('Unauthorized', { status: 401 });
  }

  // Get all active officers
  const { data: officers } = await supabase
    .from('users')
    .select('*')
    .in('role', ['officer', 'supervisor', 'admin'])
    .eq('is_active', true);

  for (const officer of officers) {
    await sendDailyDigest(officer);
  }

  return NextResponse.json({ sent: officers.length });
}

async function sendDailyDigest(officer: User) {
  // Get today's tasks
  const dueToday = await getTasksDueToday(officer.id);
  const overdue = await getOverdueTasks(officer.id);
  const atRisk = await getSLAAtRiskRequests(officer.id);
  const stats = await getWeeklyStats(officer.id);

  const html = renderDigestEmail({
    name: officer.name,
    dueToday,
    overdue,
    atRisk,
    stats,
    language: officer.language || 'ar'
  });

  await sendEmail({
    to: officer.email,
    subject: 'Your Daily Digest - Tasheel',
    html
  });
}
```

**Netlify Cron Setup:**
```toml
# netlify.toml
[[plugins]]
  package = "@netlify/plugin-scheduled-functions"

[build]
  functions = "netlify/functions"

[[plugins]]
  package = "@netlify/plugin-scheduled-functions"

  [plugins.inputs]
    schedule = "30 8 * * *" # 8:30 AM daily
```

**Tasks:**
- [ ] Build daily digest email template
- [ ] Implement digest cron job
- [ ] Set up Netlify scheduled function
- [ ] Test digest sends at 8:30 AM

---

#### 4.3 SLA Alerts & Escalation

**SLA Check Cron:**
```typescript
// app/api/cron/sla-check/route.ts
export async function GET(request: Request) {
  // Verify cron secret
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return new Response('Unauthorized', { status: 401 });
  }

  // Get all active applications
  const { data: applications } = await supabase
    .from('applications')
    .select(`
      *,
      sla_configs(*),
      users(name, email)
    `)
    .in('status', ['new', 'in_progress', 'screening', 'submitted_to_ministry', 'pending_feedback']);

  for (const app of applications) {
    const sla = calculateSLA(app, app.sla_configs);

    // 70% warning
    if (sla.percentElapsed >= 70 && sla.percentElapsed < 100 && !app.sla_warning_sent) {
      await sendSLAWarningEmail(app.assigned_to, app);
      await supabase
        .from('applications')
        .update({ sla_warning_sent: true })
        .eq('id', app.id);

      await logAutomation('sla_warning', app.id);
    }

    // 100% breach
    if (sla.percentElapsed >= 100 && !app.sla_breach_sent) {
      // Email officer
      await sendSLABreachEmail(app.assigned_to, app);

      // Email supervisor
      const supervisor = await getSupervisor();
      await sendSLABreachEmail(supervisor.email, app);

      // Create escalation task
      await createTask({
        application_id: app.id,
        title: `URGENT: SLA Breached - ${app.order_number}`,
        type: 'escalation',
        assigned_to: supervisor.id,
        priority: 'urgent',
        due_date: new Date() // immediately
      });

      await supabase
        .from('applications')
        .update({ sla_breach_sent: true })
        .eq('id', app.id);

      await logAutomation('sla_breach', app.id);
    }
  }

  return NextResponse.json({ checked: applications.length });
}
```

**Add to applications table:**
```sql
ALTER TABLE applications ADD COLUMN sla_warning_sent BOOLEAN DEFAULT false;
ALTER TABLE applications ADD COLUMN sla_breach_sent BOOLEAN DEFAULT false;
```

**Schedule:**
```toml
# netlify.toml - run every hour
[[plugins.inputs.schedules]]
  path = "/api/cron/sla-check"
  schedule = "0 * * * *" # every hour
```

**Tasks:**
- [ ] Add SLA tracking columns to applications
- [ ] Implement SLA check cron
- [ ] Create SLA warning email template
- [ ] Create SLA breach email template
- [ ] Set up hourly cron
- [ ] Test SLA alerts trigger

---

#### 4.4 Payment Reminders

**Payment Reminder Cron:**
```typescript
// app/api/cron/payment-reminders/route.ts
export async function GET(request: Request) {
  // Verify cron secret
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return new Response('Unauthorized', { status: 401 });
  }

  // Get unpaid invoices older than 48 hours
  const { data: invoices } = await supabase
    .from('invoices')
    .select(`
      *,
      applications(order_number, customer_email, customer_name)
    `)
    .eq('status', 'pending')
    .lt('created_at', new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString())
    .eq('reminder_sent', false);

  for (const invoice of invoices) {
    await sendPaymentReminderEmail({
      to: invoice.applications.customer_email,
      customerName: invoice.applications.customer_name,
      orderNumber: invoice.applications.order_number,
      amount: invoice.amount,
      paymentLink: invoice.payment_link
    });

    await supabase
      .from('invoices')
      .update({ reminder_sent: true })
      .eq('id', invoice.id);

    await logAutomation('payment_reminder', invoice.application_id);
  }

  return NextResponse.json({ sent: invoices.length });
}
```

**Add to invoices table:**
```sql
ALTER TABLE invoices ADD COLUMN reminder_sent BOOLEAN DEFAULT false;
```

**Tasks:**
- [ ] Add reminder_sent column
- [ ] Implement payment reminder cron
- [ ] Create reminder email template
- [ ] Set up daily cron (runs once per day)
- [ ] Test reminder sends after 48 hours

---

#### 4.5 Kanban Board

**Component:**
```typescript
// components/KanbanBoard.tsx
'use client';
import { DndContext, DragOverlay } from '@dnd-kit/core';

export function KanbanBoard({ applications, pipeline }: KanbanBoardProps) {
  const [activeId, setActiveId] = useState(null);

  const grouped = useMemo(() => {
    const groups: Record<string, Application[]> = {};
    pipeline.forEach(stage => {
      groups[stage.key] = applications.filter(app => app.status === stage.key);
    });
    return groups;
  }, [applications, pipeline]);

  async function handleDragEnd(event: DragEndEvent) {
    const { active, over } = event;

    if (!over) return;

    const applicationId = active.id;
    const newStatus = over.id as string;

    // Update status via API
    await fetch(`/api/applications/${applicationId}/status`, {
      method: 'PATCH',
      body: JSON.stringify({ status: newStatus }),
      headers: { 'Content-Type': 'application/json' }
    });

    // Refresh
    router.refresh();
  }

  return (
    <DndContext onDragEnd={handleDragEnd}>
      <div className="flex gap-4 overflow-x-auto">
        {pipeline.map(stage => (
          <KanbanColumn
            key={stage.key}
            stage={stage}
            applications={grouped[stage.key] || []}
          />
        ))}
      </div>
    </DndContext>
  );
}
```

**Tasks:**
- [ ] Install @dnd-kit/core
- [ ] Build KanbanBoard component
- [ ] Build KanbanColumn component
- [ ] Build KanbanCard component
- [ ] Add drag-and-drop status updates
- [ ] Add filters (by officer, service, priority)
- [ ] Test on desktop (mobile shows list)

---

#### 4.6 Data Exports

**Export API:**
```typescript
// app/api/export/requests/route.ts
export async function POST(request: Request) {
  const user = await getAuthUser();
  const { filters, format } = await request.json(); // format: 'csv' or 'xlsx'

  // Build query based on filters
  let query = supabase
    .from('applications')
    .select(`
      order_number,
      created_at,
      customer_name,
      customer_email,
      customer_phone,
      services(name_en, name_ar),
      status,
      users(name),
      invoices(amount, status)
    `);

  if (filters.status) query = query.in('status', filters.status);
  if (filters.dateFrom) query = query.gte('created_at', filters.dateFrom);
  if (filters.dateTo) query = query.lte('created_at', filters.dateTo);

  const { data: requests } = await query;

  if (format === 'csv') {
    const csv = convertToCSV(requests);
    return new Response(csv, {
      headers: {
        'Content-Type': 'text/csv',
        'Content-Disposition': `attachment; filename="requests-${Date.now()}.csv"`
      }
    });
  } else {
    const xlsx = convertToXLSX(requests);
    return new Response(xlsx, {
      headers: {
        'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'Content-Disposition': `attachment; filename="requests-${Date.now()}.xlsx"`
      }
    });
  }
}

function convertToCSV(data: any[]): string {
  const headers = ['Order Number', 'Date', 'Customer', 'Email', 'Phone', 'Service', 'Status', 'Assigned To', 'Amount'];
  const rows = data.map(row => [
    row.order_number,
    new Date(row.created_at).toLocaleDateString(),
    row.customer_name,
    row.customer_email,
    row.customer_phone,
    row.services.name_en,
    row.status,
    row.users?.name || 'Unassigned',
    row.invoices?.[0]?.amount || ''
  ]);

  return [headers, ...rows].map(row => row.join(',')).join('\n');
}
```

**Tasks:**
- [ ] Build export API
- [ ] Add CSV conversion
- [ ] Add XLSX conversion (use xlsx library)
- [ ] Build export UI (button + filters)
- [ ] Test export with different filters

---

#### 4.7 Audit Logs Viewer

**Page:**
```typescript
// app/[locale]/admin/audit-logs/page.tsx
export default async function AuditLogsPage({ searchParams }) {
  const user = await getAuthUser();

  if (!['admin', 'auditor'].includes(user.role)) {
    return <div>Access Denied</div>;
  }

  let query = supabase
    .from('application_events')
    .select(`
      *,
      users(name),
      applications(order_number)
    `)
    .order('created_at', { ascending: false })
    .limit(100);

  if (searchParams.user) query = query.eq('user_id', searchParams.user);
  if (searchParams.type) query = query.eq('event_type', searchParams.type);
  if (searchParams.dateFrom) query = query.gte('created_at', searchParams.dateFrom);

  const { data: logs } = await query;

  return (
    <div>
      <AuditLogFilters />
      <AuditLogTable logs={logs} />
    </div>
  );
}
```

**Tasks:**
- [ ] Build audit logs page
- [ ] Add filters (user, date, event type)
- [ ] Build AuditLogTable component
- [ ] Add export audit logs button
- [ ] Test logs are immutable (can't edit/delete)

---

### Phase 4 Deployment Checklist

- [ ] Auto-create tasks triggers on status change
- [ ] Daily digest emails send at 8:30 AM
- [ ] SLA alerts send at 70% and 100%
- [ ] Payment reminders send after 48 hours
- [ ] Kanban board drag-and-drop works
- [ ] CSV/Excel export works
- [ ] Audit logs viewer shows all events
- [ ] Test all automations with real data
- [ ] Deploy to Netlify
- [ ] Verify cron jobs running

---

## Deployment & DevOps

### Environment Variables

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# Email
RESEND_API_KEY=
CONTACT_EMAIL=
CONTACT_NAME=

# Payment Gateway
PAYMENT_GATEWAY_SECRET_KEY=
NEXT_PUBLIC_PAYMENT_GATEWAY_PUBLIC_KEY=
PAYMENT_WEBHOOK_SECRET=

# Site
NEXT_PUBLIC_SITE_URL=

# Admin
ADMIN_PASSWORD= # for simple password auth

# Cron
CRON_SECRET= # random secret for cron endpoints
```

### Netlify Configuration

```toml
# netlify.toml
[build]
  command = "npm run build"
  publish = ".next"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

[[plugins]]
  package = "@netlify/plugin-nextjs"

[[plugins]]
  package = "@netlify/plugin-scheduled-functions"

  [plugins.inputs]
    # Daily digest at 8:30 AM Palestine time (UTC+2)
    [[plugins.inputs.schedules]]
      path = "/api/cron/daily-digest"
      schedule = "30 6 * * *" # 6:30 UTC = 8:30 Palestine

    # SLA check every hour
    [[plugins.inputs.schedules]]
      path = "/api/cron/sla-check"
      schedule = "0 * * * *"

    # Payment reminders daily at 10 AM
    [[plugins.inputs.schedules]]
      path = "/api/cron/payment-reminders"
      schedule = "0 8 * * *" # 8:00 UTC = 10:00 Palestine
```

---

## Testing Checklist

### Phase 1 Tests
- [ ] Homepage loads in Arabic and English
- [ ] Language switcher works
- [ ] All 30 services visible
- [ ] Service detail pages render
- [ ] Quote form submits successfully
- [ ] Confirmation email received (customer)
- [ ] Alert email received (admin)
- [ ] Admin can login
- [ ] Admin sees request in panel
- [ ] Order number auto-generated correctly

### Phase 2 Tests
- [ ] Customer can register
- [ ] Customer can login
- [ ] Password reset works
- [ ] Customer sees their requests
- [ ] File upload works
- [ ] File download works
- [ ] Admin creates invoice
- [ ] Payment link sent to customer
- [ ] Customer pays successfully
- [ ] Webhook updates invoice status
- [ ] Invoice PDF generates correctly
- [ ] All 6 email types send

### Phase 3 Tests
- [ ] All 149 services in database
- [ ] Search works across services
- [ ] Filters work (category, price, time)
- [ ] Admin creates user with role
- [ ] Officer only sees assigned requests
- [ ] Supervisor sees all requests
- [ ] Intake can assign requests
- [ ] Auditor has read-only access
- [ ] Task creation works
- [ ] Task assignment sends email
- [ ] SLA countdown shows correctly
- [ ] Admin dashboard renders charts
- [ ] Supervisor dashboard shows team metrics
- [ ] Officer dashboard shows my stats

### Phase 4 Tests
- [ ] Status change auto-creates task
- [ ] Daily digest sends at 8:30 AM
- [ ] SLA warning email at 70%
- [ ] SLA breach email at 100%
- [ ] Escalation task created on breach
- [ ] Payment reminder after 48 hours
- [ ] Kanban drag-and-drop updates status
- [ ] CSV export downloads
- [ ] Excel export downloads
- [ ] Audit logs show all events
- [ ] Automation logs recorded

---

## Development Tips

### Using AI to Accelerate

1. **Service Data Generation:**
```
Prompt: "Generate a service object for a Birth Certificate Translation service in JSON format following this schema: [paste Service type]. Include English and Arabic text."
```

2. **Translation:**
```
Prompt: "Translate the following UI strings to Arabic (formal): [paste English strings]"
```

3. **Email Templates:**
```
Prompt: "Create an HTML email template for payment confirmation. Include order number, amount, and receipt download link. Make it bilingual (Arabic/English). Use Tailwind for styling."
```

4. **Component Generation:**
```
Prompt: "Create a Material UI DataGrid component that displays a list of applications with columns: order number, customer name, service, status, date. Add search and filter functionality."
```

### Git Workflow

**Branch Strategy:**
- `main` - production (auto-deploys to Netlify)
- `dev` - development branch
- `feature/phase-X` - feature branches per phase

**Commits:**
```bash
git commit -m "feat(phase1): add bilingual service catalog"
git commit -m "fix(phase2): payment webhook signature verification"
git commit -m "chore(phase3): seed SLA configs for all services"
```

**Weekly Deploys:**
- End of Week 1: Deploy Phase 1 to main
- End of Week 2: Deploy Phase 2 to main
- End of Week 4: Deploy Phase 3 to main
- End of Week 5: Deploy Phase 4 to main

---

## Handoff Documentation

### For Client

Create simple guides:
1. **How to Add a New Service** (admin guide)
2. **How to Process a Request** (officer guide)
3. **How to Create an Invoice** (admin guide)
4. **How to View Reports** (supervisor guide)

### For Future Developers

- **README.md** - Setup instructions
- **ARCHITECTURE.md** - System overview
- **API.md** - API endpoints documentation
- **DATABASE.md** - Schema documentation

---

## Post-Launch (Week 6+)

### Monitoring
- Set up error tracking (Sentry)
- Monitor Supabase usage
- Track email delivery rates
- Monitor payment success rates

### Optimization
- Add database indexes for slow queries
- Optimize image loading
- Enable Next.js caching where appropriate

### Future Features (Phase 5+)
- WhatsApp Business API
- SMS notifications
- Mobile app (React Native)
- Advanced analytics
- Multi-branch support

---

## Data Flow & API Integration

This section maps **every user action â†’ API call â†’ database operation** to ensure complete system coherence.

### Phase 1: Public Website + Basic Admin

#### Flow 1: Customer Submits Quote Request

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER ACTION                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Customer visits /services/id-card-renewal/quote             â”‚
â”‚ Fills form: name, email, phone, message, urgency           â”‚
â”‚ Clicks "Submit Request"                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND (Client Component)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Component: QuoteRequestForm.tsx                             â”‚
â”‚ Validation: Zod schema (name required, email format, etc.) â”‚
â”‚ API Call:                                                   â”‚
â”‚   POST /api/quote-requests                                  â”‚
â”‚   Body: { serviceId, name, email, phone, message, urgency }â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND (API Route)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: app/api/quote-requests/route.ts                      â”‚
â”‚                                                             â”‚
â”‚ 1. Validate request body                                    â”‚
â”‚ 2. Generate order number:                                   â”‚
â”‚    orderNumber = await generateOrderNumber()               â”‚
â”‚    â†’ "TSH-20250122-001"                                     â”‚
â”‚                                                             â”‚
â”‚ 3. Insert to database:                                      â”‚
â”‚    await supabase.from('applications').insert({            â”‚
â”‚      order_number: orderNumber,                            â”‚
â”‚      service_id: serviceId,                                â”‚
â”‚      customer_name: name,                                  â”‚
â”‚      customer_email: email,                                â”‚
â”‚      customer_phone: phone,                                â”‚
â”‚      message: message,                                     â”‚
â”‚      urgency: urgency,                                     â”‚
â”‚      status: 'new',                                        â”‚
â”‚      submitted_at: new Date()                              â”‚
â”‚    })                                                      â”‚
â”‚                                                             â”‚
â”‚ 4. Create event log:                                        â”‚
â”‚    await supabase.from('application_events').insert({      â”‚
â”‚      application_id: newApp.id,                            â”‚
â”‚      event_type: 'submitted',                              â”‚
â”‚      notes: 'Quote request submitted'                      â”‚
â”‚    })                                                      â”‚
â”‚                                                             â”‚
â”‚ 5. Queue emails:                                            â”‚
â”‚    // Email to customer                                     â”‚
â”‚    await queueEmail(                                        â”‚
â”‚      email,                                                â”‚
â”‚      'Quote Request Received',                             â”‚
â”‚      'quote-request-received',                             â”‚
â”‚      { orderNumber, serviceName }                          â”‚
â”‚    )                                                       â”‚
â”‚                                                             â”‚
â”‚    // Email to admin                                        â”‚
â”‚    await queueEmail(                                        â”‚
â”‚      ADMIN_EMAIL,                                          â”‚
â”‚      'New Quote Request',                                  â”‚
â”‚      'admin-new-request',                                  â”‚
â”‚      { orderNumber, name, service, urgency }              â”‚
â”‚    )                                                       â”‚
â”‚                                                             â”‚
â”‚ 6. Return response:                                         â”‚
â”‚    return { success: true, orderNumber }                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE CHANGES                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Table: applications                                         â”‚
â”‚ INSERT: 1 row (order_number, service_id, customer details) â”‚
â”‚                                                             â”‚
â”‚ Table: application_events                                   â”‚
â”‚ INSERT: 1 row (event_type: 'submitted')                    â”‚
â”‚                                                             â”‚
â”‚ Table: email_queue                                          â”‚
â”‚ INSERT: 2 rows (customer email + admin email)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UI RESPONSE                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Show success message:                                       â”‚
â”‚ "âœ“ Request submitted! Order #TSH-20250122-001"            â”‚
â”‚ "Check your email for confirmation."                       â”‚
â”‚                                                             â”‚
â”‚ Redirect: /track?order=TSH-20250122-001                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tables Involved:**
- `applications` - Main order record
- `services` - Service details (referenced)
- `application_events` - Event log
- `email_queue` - Queued emails

**Files to Create:**
- `app/api/quote-requests/route.ts` - API handler
- `lib/utils/order-number.ts` - Order number generator (already documented)
- `lib/email/queue.ts` - Email queue (already documented)

---

#### Flow 2: Admin Views Orders List

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER ACTION                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Admin navigates to /admin/orders                            â”‚
â”‚ Optionally: searches "john" or filters by status "new"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND (Server Component)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Component: app/admin/orders/page.tsx                        â”‚
â”‚                                                             â”‚
â”‚ Server-side fetch:                                          â”‚
â”‚   const response = await fetch(                             â”‚
â”‚     '/api/admin/orders?search=john&status=new&page=1',     â”‚
â”‚     { headers: { Cookie: cookies().toString() } }          â”‚
â”‚   )                                                         â”‚
â”‚   const orders = await response.json()                      â”‚
â”‚                                                             â”‚
â”‚ Render: <OrdersTable orders={orders} />                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND (API Route)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: app/api/admin/orders/route.ts                        â”‚
â”‚                                                             â”‚
â”‚ 1. Check authentication:                                    â”‚
â”‚    const session = await getAdminSession(cookies())        â”‚
â”‚    if (!session) return 401                                â”‚
â”‚                                                             â”‚
â”‚ 2. Parse query params:                                      â”‚
â”‚    const { search, status, page = 1, limit = 20 } = paramsâ”‚
â”‚                                                             â”‚
â”‚ 3. Build query:                                             â”‚
â”‚    let query = supabase                                     â”‚
â”‚      .from('applications')                                  â”‚
â”‚      .select(`                                              â”‚
â”‚        *,                                                   â”‚
â”‚        services(name_en, name_ar),                         â”‚
â”‚        users(name)                                         â”‚
â”‚      `)                                                     â”‚
â”‚                                                             â”‚
â”‚    if (search) {                                            â”‚
â”‚      query = query.or(`                                     â”‚
â”‚        order_number.ilike.%${search}%,                     â”‚
â”‚        customer_name.ilike.%${search}%,                    â”‚
â”‚        customer_email.ilike.%${search}%                    â”‚
â”‚      `)                                                     â”‚
â”‚    }                                                       â”‚
â”‚                                                             â”‚
â”‚    if (status) {                                            â”‚
â”‚      query = query.eq('status', status)                    â”‚
â”‚    }                                                       â”‚
â”‚                                                             â”‚
â”‚    query = query                                            â”‚
â”‚      .order('submitted_at', { ascending: false })          â”‚
â”‚      .range((page - 1) * limit, page * limit - 1)         â”‚
â”‚                                                             â”‚
â”‚ 4. Execute query:                                           â”‚
â”‚    const { data, error, count } = await query              â”‚
â”‚                                                             â”‚
â”‚ 5. Return response:                                         â”‚
â”‚    return {                                                 â”‚
â”‚      orders: data,                                         â”‚
â”‚      total: count,                                         â”‚
â”‚      page,                                                 â”‚
â”‚      limit                                                 â”‚
â”‚    }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE QUERY                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SELECT applications.*, services.name_en, users.name        â”‚
â”‚ FROM applications                                           â”‚
â”‚ LEFT JOIN services ON applications.service_id = services.idâ”‚
â”‚ LEFT JOIN users ON applications.assigned_to = users.id     â”‚
â”‚ WHERE (order_number ILIKE '%john%' OR ...)                 â”‚
â”‚   AND status = 'new'                                       â”‚
â”‚ ORDER BY submitted_at DESC                                  â”‚
â”‚ LIMIT 20 OFFSET 0                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UI RENDER                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Display table with columns:                                â”‚
â”‚ - Order Number (clickable â†’ /admin/orders/[id])            â”‚
â”‚ - Customer Name                                             â”‚
â”‚ - Service                                                   â”‚
â”‚ - Status Badge (color-coded)                               â”‚
â”‚ - Submitted Date                                            â”‚
â”‚ - Assigned To                                               â”‚
â”‚ - Actions (View, Edit)                                      â”‚
â”‚                                                             â”‚
â”‚ Pagination: [1] 2 3 ... (total: 142 orders)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tables Involved:**
- `applications` - Main orders table
- `services` - Service names (JOIN)
- `users` - Assigned officer names (JOIN)

**Files to Create:**
- `app/api/admin/orders/route.ts` - API handler
- `components/admin/OrdersTable.tsx` - Table component
- `lib/admin-auth.ts` - Session validation

---

#### Flow 3: Admin Updates Order Status

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER ACTION                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Admin on /admin/orders/[id]                                 â”‚
â”‚ Changes status dropdown: "New" â†’ "Screening"                â”‚
â”‚ Adds note: "Verified documents"                             â”‚
â”‚ Clicks "Update Status"                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND (Client Component)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Component: OrderStatusForm.tsx                              â”‚
â”‚                                                             â”‚
â”‚ API Call:                                                   â”‚
â”‚   PATCH /api/admin/orders/[id]                             â”‚
â”‚   Body: {                                                   â”‚
â”‚     status: 'screening',                                   â”‚
â”‚     note: 'Verified documents'                             â”‚
â”‚   }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND (API Route)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: app/api/admin/orders/[id]/route.ts                   â”‚
â”‚                                                             â”‚
â”‚ 1. Check authentication                                     â”‚
â”‚ 2. Validate: status is valid enum value                    â”‚
â”‚                                                             â”‚
â”‚ 3. Update application:                                      â”‚
â”‚    await supabase                                           â”‚
â”‚      .from('applications')                                  â”‚
â”‚      .update({                                              â”‚
â”‚        status: 'screening',                                â”‚
â”‚        updated_at: new Date()                              â”‚
â”‚      })                                                     â”‚
â”‚      .eq('id', applicationId)                              â”‚
â”‚                                                             â”‚
â”‚ 4. Create event log:                                        â”‚
â”‚    await supabase.from('application_events').insert({      â”‚
â”‚      application_id: applicationId,                        â”‚
â”‚      event_type: 'status_changed',                         â”‚
â”‚      user_id: session.user.id,                            â”‚
â”‚      notes: 'Verified documents',                          â”‚
â”‚      metadata: { old_status: 'new', new_status: 'screening'}â”‚
â”‚    })                                                      â”‚
â”‚                                                             â”‚
â”‚ 5. Queue customer notification email:                       â”‚
â”‚    await queueEmail(                                        â”‚
â”‚      customerEmail,                                        â”‚
â”‚      'Status Update',                                      â”‚
â”‚      'status-changed',                                     â”‚
â”‚      { orderNumber, newStatus: 'Screening', note }        â”‚
â”‚    )                                                       â”‚
â”‚                                                             â”‚
â”‚ 6. Auto-create task (Phase 3):                             â”‚
â”‚    if (status === 'screening') {                           â”‚
â”‚      await supabase.from('tasks').insert({                 â”‚
â”‚        application_id: applicationId,                      â”‚
â”‚        title: 'Verify all documents',                     â”‚
â”‚        type: 'review',                                    â”‚
â”‚        assigned_to: session.user.id,                      â”‚
â”‚        due_date: addBusinessHours(new Date(), 4)          â”‚
â”‚      })                                                    â”‚
â”‚    }                                                       â”‚
â”‚                                                             â”‚
â”‚ 7. Return updated application                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE CHANGES                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Table: applications                                         â”‚
â”‚ UPDATE: status = 'screening', updated_at = NOW()           â”‚
â”‚                                                             â”‚
â”‚ Table: application_events                                   â”‚
â”‚ INSERT: 1 row (status_changed event)                       â”‚
â”‚                                                             â”‚
â”‚ Table: email_queue                                          â”‚
â”‚ INSERT: 1 row (customer notification)                      â”‚
â”‚                                                             â”‚
â”‚ Table: tasks (Phase 3)                                      â”‚
â”‚ INSERT: 1 row (auto-created task)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UI RESPONSE                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Show success toast: "âœ“ Status updated to Screening"        â”‚
â”‚ Refresh timeline to show new event                         â”‚
â”‚ Update status badge color                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tables Involved:**
- `applications` - Status update
- `application_events` - Event log
- `email_queue` - Customer notification
- `tasks` - Auto-created task (Phase 3)

---

### Phase 2: Customer Portal + Payments

#### Flow 4: Customer Registers Account

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER ACTION                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Customer visits /register                                   â”‚
â”‚ Fills: name, email, phone, password                        â”‚
â”‚ Clicks "Create Account"                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND (Client Component)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Component: RegisterForm.tsx                                 â”‚
â”‚                                                             â”‚
â”‚ Use Supabase client-side:                                   â”‚
â”‚   const { data, error } = await supabase.auth.signUp({    â”‚
â”‚     email,                                                 â”‚
â”‚     password,                                              â”‚
â”‚     options: {                                             â”‚
â”‚       data: { name, phone }                               â”‚
â”‚     }                                                      â”‚
â”‚   })                                                       â”‚
â”‚                                                             â”‚
â”‚ Then call our API to complete profile:                     â”‚
â”‚   POST /api/customer/profile                               â”‚
â”‚   Body: { name, phone }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUPABASE AUTH                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Supabase creates user in auth.users table               â”‚
â”‚ 2. Sends confirmation email (if enabled)                   â”‚
â”‚ 3. Returns user object with ID                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND (API Route)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: app/api/customer/profile/route.ts                    â”‚
â”‚                                                             â”‚
â”‚ 1. Get authenticated user:                                  â”‚
â”‚    const { data: { user } } = await supabase.auth.getUser()â”‚
â”‚    if (!user) return 401                                   â”‚
â”‚                                                             â”‚
â”‚ 2. Insert into customers table:                            â”‚
â”‚    await supabase.from('customers').insert({               â”‚
â”‚      id: user.id,  // Same as auth.users.id               â”‚
â”‚      email: user.email,                                    â”‚
â”‚      name,                                                 â”‚
â”‚      phone,                                                â”‚
â”‚      language_preference: 'ar'                             â”‚
â”‚    })                                                      â”‚
â”‚                                                             â”‚
â”‚ 3. Link existing orders (if any):                          â”‚
â”‚    // If customer submitted quotes before registering      â”‚
â”‚    await supabase                                           â”‚
â”‚      .from('applications')                                  â”‚
â”‚      .update({ customer_id: user.id })                     â”‚
â”‚      .eq('customer_email', user.email)                     â”‚
â”‚      .is('customer_id', null)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE CHANGES                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Table: auth.users (Supabase managed)                        â”‚
â”‚ INSERT: 1 row (email, encrypted password)                  â”‚
â”‚                                                             â”‚
â”‚ Table: customers                                            â”‚
â”‚ INSERT: 1 row (id matches auth.users.id)                   â”‚
â”‚                                                             â”‚
â”‚ Table: applications                                         â”‚
â”‚ UPDATE: Link existing orders to customer_id                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UI RESPONSE                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Auto-login after registration                              â”‚
â”‚ Redirect: /dashboard                                       â”‚
â”‚ Show: "Welcome, [Name]! Your account is ready."           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tables Involved:**
- `auth.users` - Supabase Auth (automatic)
- `customers` - Our customer profile table
- `applications` - Link existing orders

**Files to Create:**
- `app/register/page.tsx` - Registration page
- `components/forms/RegisterForm.tsx` - Form component
- `app/api/customer/profile/route.ts` - Profile creation

---

#### Flow 5: Admin Creates Quote â†’ Customer Pays

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ADMIN ACTION                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Admin on /admin/orders/[id]                                 â”‚
â”‚ Clicks "Create Quote"                                       â”‚
â”‚ Enters: amount = 500, notes = "Including express fee"      â”‚
â”‚ Clicks "Send Quote to Customer"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND (Admin)                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Component: QuoteCreationForm.tsx                            â”‚
â”‚                                                             â”‚
â”‚ API Call:                                                   â”‚
â”‚   POST /api/quotes                                          â”‚
â”‚   Body: {                                                   â”‚
â”‚     applicationId,                                         â”‚
â”‚     amount: 500,                                           â”‚
â”‚     notes: 'Including express fee'                        â”‚
â”‚   }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND (API Route)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: app/api/quotes/route.ts                              â”‚
â”‚                                                             â”‚
â”‚ 1. Check admin auth                                         â”‚
â”‚ 2. Get application details:                                 â”‚
â”‚    const app = await supabase                               â”‚
â”‚      .from('applications')                                  â”‚
â”‚      .select('*, customers(email)')                        â”‚
â”‚      .eq('id', applicationId)                              â”‚
â”‚      .single()                                             â”‚
â”‚                                                             â”‚
â”‚ 3. Update application status:                              â”‚
â”‚    await supabase                                           â”‚
â”‚      .from('applications')                                  â”‚
â”‚      .update({                                              â”‚
â”‚        status: 'quoted',                                   â”‚
â”‚        quoted_amount: 500,                                 â”‚
â”‚        quoted_at: new Date()                               â”‚
â”‚      })                                                     â”‚
â”‚      .eq('id', applicationId)                              â”‚
â”‚                                                             â”‚
â”‚ 4. Create payment link (PalPay/PayTabs):                   â”‚
â”‚    const paymentLink = await createPaymentLink({           â”‚
â”‚      amount: 500,                                          â”‚
â”‚      currency: 'ILS',                                      â”‚
â”‚      orderId: app.order_number,                           â”‚
â”‚      customerEmail: app.customers.email,                  â”‚
â”‚      returnUrl: `${SITE_URL}/dashboard/requests/${app.id}`,â”‚
â”‚      webhookUrl: `${SITE_URL}/api/webhooks/payment`       â”‚
â”‚    })                                                      â”‚
â”‚    // Returns: { url: 'https://palpay.ps/pay/xxx' }       â”‚
â”‚                                                             â”‚
â”‚ 5. Store payment link in DB:                               â”‚
â”‚    await supabase                                           â”‚
â”‚      .from('applications')                                  â”‚
â”‚      .update({ payment_link: paymentLink.url })           â”‚
â”‚      .eq('id', applicationId)                              â”‚
â”‚                                                             â”‚
â”‚ 6. Queue email to customer:                                â”‚
â”‚    await queueEmail(                                        â”‚
â”‚      app.customers.email,                                  â”‚
â”‚      'Your Quote is Ready',                               â”‚
â”‚      'quote-sent',                                         â”‚
â”‚      {                                                     â”‚
â”‚        orderNumber: app.order_number,                     â”‚
â”‚        amount: 500,                                       â”‚
â”‚        paymentLink: paymentLink.url,                      â”‚
â”‚        expiryHours: 48                                    â”‚
â”‚      },                                                    â”‚
â”‚      { priority: 'high' }                                 â”‚
â”‚    )                                                       â”‚
â”‚                                                             â”‚
â”‚ 7. Create event log                                        â”‚
â”‚ 8. Return success                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CUSTOMER RECEIVES EMAIL                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Subject: "Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø¬Ø§Ù‡Ø² / Your Quote is Ready"           â”‚
â”‚                                                             â”‚
â”‚ Content:                                                    â”‚
â”‚ "Your quote for Order #TSH-20250122-001 is ready"         â”‚
â”‚ "Service: ID Card Renewal"                                 â”‚
â”‚ "Amount: 500 ILS"                                          â”‚
â”‚ "                                                           â”‚
â”‚ [Pay Now Button] â†’ paymentLink                             â”‚
â”‚                                                             â”‚
â”‚ "This quote expires in 48 hours."                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CUSTOMER CLICKS PAY NOW                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Redirects to: https://palpay.ps/pay/xxx                    â”‚
â”‚ Customer enters card details                                â”‚
â”‚ Completes payment                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PAYMENT GATEWAY WEBHOOK                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PalPay/PayTabs sends webhook:                              â”‚
â”‚   POST /api/webhooks/payment                               â”‚
â”‚   Body: {                                                   â”‚
â”‚     event: 'payment.success',                             â”‚
â”‚     orderId: 'TSH-20250122-001',                          â”‚
â”‚     amount: 500,                                          â”‚
â”‚     transactionId: 'TXN-12345',                           â”‚
â”‚     signature: '...'                                      â”‚
â”‚   }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND (Webhook Handler)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: app/api/webhooks/payment/route.ts                    â”‚
â”‚                                                             â”‚
â”‚ 1. Verify signature (security!)                            â”‚
â”‚ 2. Find application by order_number                        â”‚
â”‚ 3. Update application:                                      â”‚
â”‚    await supabase.from('applications').update({            â”‚
â”‚      payment_status: 'paid',                               â”‚
â”‚      payment_date: new Date(),                             â”‚
â”‚      transaction_id: 'TXN-12345',                          â”‚
â”‚      status: 'paid'                                        â”‚
â”‚    })                                                      â”‚
â”‚                                                             â”‚
â”‚ 4. Generate invoice:                                        â”‚
â”‚    const invoiceId = await generateInvoicePDF({            â”‚
â”‚      application,                                          â”‚
â”‚      amount: 500                                           â”‚
â”‚    })                                                      â”‚
â”‚                                                             â”‚
â”‚ 5. Queue confirmation email:                               â”‚
â”‚    await queueEmail(..., 'payment-confirmed', ...)         â”‚
â”‚                                                             â”‚
â”‚ 6. Create event log                                        â”‚
â”‚ 7. Return 200 OK to payment gateway                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE CHANGES                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Table: applications                                         â”‚
â”‚ UPDATE: payment_status = 'paid', status = 'paid'           â”‚
â”‚                                                             â”‚
â”‚ Table: invoices                                             â”‚
â”‚ INSERT: 1 row (invoice PDF generated)                      â”‚
â”‚                                                             â”‚
â”‚ Table: application_events                                   â”‚
â”‚ INSERT: 1 row (payment_received)                           â”‚
â”‚                                                             â”‚
â”‚ Table: email_queue                                          â”‚
â”‚ INSERT: 1 row (payment confirmation)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tables Involved:**
- `applications` - Status + payment info
- `invoices` - Generated invoice
- `application_events` - Payment event
- `email_queue` - Notifications

**External APIs:**
- PalPay/PayTabs - Payment link creation
- PalPay/PayTabs - Webhook callback

**Files to Create:**
- `app/api/quotes/route.ts` - Quote creation
- `app/api/webhooks/payment/route.ts` - Webhook handler
- `lib/payments/palpay.ts` - Payment gateway integration
- `lib/payments/generate-invoice.ts` - Invoice PDF generation

---

### Phase 3: Team Management

#### Flow 6: Supervisor Assigns Order to Officer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER ACTION                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Supervisor on /admin/orders/[id]                            â”‚
â”‚ Clicks "Assign" dropdown                                    â”‚
â”‚ Selects: "Officer - Sara Ahmad"                            â”‚
â”‚ Clicks "Assign"                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ API Call:                                                   â”‚
â”‚   POST /api/orders/[id]/assign                             â”‚
â”‚   Body: { userId: 'officer-sara-id' }                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File: app/api/orders/[id]/assign/route.ts                  â”‚
â”‚                                                             â”‚
â”‚ 1. Check auth: user is supervisor or admin                 â”‚
â”‚ 2. Validate: assignee has 'officer' role                   â”‚
â”‚                                                             â”‚
â”‚ 3. Update application:                                      â”‚
â”‚    await supabase.from('applications').update({            â”‚
â”‚      assigned_to: officerId,                               â”‚
â”‚      assigned_at: new Date()                               â”‚
â”‚    })                                                      â”‚
â”‚                                                             â”‚
â”‚ 4. Create event log                                        â”‚
â”‚                                                             â”‚
â”‚ 5. Send email to officer (Phase 4):                        â”‚
â”‚    "You've been assigned Order #TSH-20250122-001"          â”‚
â”‚                                                             â”‚
â”‚ 6. Auto-create initial task:                               â”‚
â”‚    await supabase.from('tasks').insert({                   â”‚
â”‚      application_id,                                       â”‚
â”‚      title: 'Review and process order',                   â”‚
â”‚      assigned_to: officerId,                              â”‚
â”‚      type: 'review',                                      â”‚
â”‚      due_date: addBusinessHours(new Date(), 8)            â”‚
â”‚    })                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE CHANGES                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Table: applications                                         â”‚
â”‚ UPDATE: assigned_to = officer_id                           â”‚
â”‚                                                             â”‚
â”‚ Table: tasks                                                â”‚
â”‚ INSERT: 1 row (initial review task)                        â”‚
â”‚                                                             â”‚
â”‚ Table: application_events                                   â”‚
â”‚ INSERT: 1 row (assigned event)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**RLS Check:** Ensure officer can now see this order in their queries.

---

### Complete API Routes Ã— Frontend Pages Matrix

| Frontend Page | HTTP Method | API Route | Tables Accessed | Auth Required |
|--------------|-------------|-----------|----------------|---------------|
| **Public Pages** |
| `/services/[slug]/quote` | POST | `/api/quote-requests` | applications, application_events, email_queue | No |
| `/track` | GET | `/api/track/[orderNumber]` | applications, services, application_events | No |
| `/contact` | POST | `/api/contact` | email_queue | No |
| **Admin Pages** |
| `/admin` (dashboard) | GET | `/api/admin/stats` | applications (aggregates) | Admin Session |
| `/admin/orders` | GET | `/api/admin/orders` | applications, services, users | Admin Session |
| `/admin/orders/[id]` | GET | `/api/admin/orders/[id]` | applications, services, customers, files, application_events | Admin Session |
| `/admin/orders/[id]` | PATCH | `/api/admin/orders/[id]` | applications, application_events, email_queue | Admin Session |
| `/admin/orders/[id]` (quote) | POST | `/api/quotes` | applications, email_queue | Admin Session |
| **Customer Portal** |
| `/register` | - | Supabase Auth (client) | auth.users, customers | No |
| `/login` | - | Supabase Auth (client) | auth.users | No |
| `/dashboard` | GET | `/api/customer/dashboard` | applications (filtered by customer_id) | Supabase Auth |
| `/dashboard/requests` | GET | `/api/customer/requests` | applications, services, invoices | Supabase Auth |
| `/dashboard/requests/[id]` | GET | `/api/customer/requests/[id]` | applications, files, application_events, invoices | Supabase Auth + RLS |
| `/dashboard/requests/[id]` (upload) | POST | `/api/customer/requests/[id]/files` | files, Supabase Storage | Supabase Auth + RLS |
| **Team Management (Phase 3)** |
| `/admin/users` | GET | `/api/admin/users` | users | Admin/Supervisor |
| `/admin/users` | POST | `/api/admin/users` | users, auth.users | Admin only |
| `/admin/tasks` | GET | `/api/tasks` | tasks, applications | Team member |
| `/admin/tasks` | POST | `/api/tasks` | tasks | Team member |
| **Reports (Phase 4)** |
| `/admin/reports` | GET | `/api/reports/revenue` | applications, invoices | Admin/Supervisor |
| `/admin/reports` | GET | `/api/reports/services` | applications, services | Admin/Supervisor |
| `/admin/reports` | GET | `/api/reports/team` | applications, users, tasks | Admin/Supervisor |
| **Webhooks & Cron** |
| External webhook | POST | `/api/webhooks/payment` | applications, invoices, application_events | Signature verification |
| Netlify cron | POST | `/api/cron/process-emails` | email_queue | Cron secret token |
| Netlify cron | POST | `/api/cron/daily-digest` | tasks, applications, users, email_queue | Cron secret token |
| Netlify cron | POST | `/api/cron/sla-check` | applications, users, email_queue | Cron secret token |

---

### Security Validation Checklist

For **EVERY** API route, ensure:

1. âœ… **Authentication Check**
   ```typescript
   // Admin routes
   const session = await getAdminSession(cookies())
   if (!session) return new Response('Unauthorized', { status: 401 })

   // Customer routes
   const { data: { user } } = await supabase.auth.getUser()
   if (!user) return new Response('Unauthorized', { status: 401 })
   ```

2. âœ… **Authorization Check (RLS + Code)**
   ```typescript
   // Example: Customer can only access their own orders
   const { data } = await supabase
     .from('applications')
     .select('*')
     .eq('id', applicationId)
     .eq('customer_id', user.id)  // RLS enforces this too
     .single()

   if (!data) return new Response('Forbidden', { status: 403 })
   ```

3. âœ… **Input Validation**
   ```typescript
   // Use Zod
   const schema = z.object({
     email: z.string().email(),
     amount: z.number().positive().max(100000)
   })

   const result = schema.safeParse(body)
   if (!result.success) {
     return new Response(JSON.stringify({ errors: result.error }), { status: 400 })
   }
   ```

4. âœ… **Rate Limiting (Phase 4)**
   ```typescript
   // Protect public endpoints
   const limiter = new RateLimiter({ max: 10, window: '1m' })
   if (!limiter.check(ip)) {
     return new Response('Too many requests', { status: 429 })
   }
   ```

5. âœ… **Webhook Signature Verification**
   ```typescript
   const signature = headers.get('x-webhook-signature')
   if (!verifyWebhookSignature(body, signature)) {
     return new Response('Invalid signature', { status: 401 })
   }
   ```

---

## Appendix: Quick Reference

### A. Environment Variables (.env.local)

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Admin Auth (Phase 1)
ADMIN_SESSION_SECRET=your-random-32-char-secret-here
ADMIN_EMAIL=admin@tasheel.ps
ADMIN_PASSWORD=your-secure-password

# Email (Phase 1)
RESEND_API_KEY=re_xxxxxxxxxxxxx
EMAIL_FROM=Tasheel <noreply@tasheel.ps>

# Payment Gateway (Phase 2)
# Option A: PalPay
PALPAY_MERCHANT_ID=xxxxx
PALPAY_API_KEY=xxxxx
PALPAY_WEBHOOK_SECRET=xxxxx

# Option B: PayTabs
PAYTABS_SERVER_KEY=xxxxx
PAYTABS_PROFILE_ID=xxxxx
PAYTABS_WEBHOOK_SECRET=xxxxx

# URLs
NEXT_PUBLIC_SITE_URL=https://tasheel.ps
NEXT_PUBLIC_ADMIN_URL=https://tasheel.ps/admin

# Palestine Timezone (Phase 3)
TZ=Asia/Gaza
```

---

### B. API Routes Map

#### Phase 1: Public + Admin Basic

**Public Routes:**
```
POST   /api/quote-requests          # Submit quote request
GET    /api/services                # List services (with filters)
GET    /api/services/[slug]         # Get service by slug
GET    /api/track/[orderNumber]     # Track order status
POST   /api/contact                 # Contact form submission
```

**Admin Routes:**
```
POST   /api/admin/login             # Admin login (session-based)
POST   /api/admin/logout            # Admin logout
GET    /api/admin/orders            # List all orders
GET    /api/admin/orders/[id]       # Get order detail
PATCH  /api/admin/orders/[id]       # Update order status
POST   /api/admin/orders/[id]/notes # Add note to order
```

---

#### Phase 2: Customer Auth + Payments

**Customer Auth:**
```
POST   /api/auth/register           # Customer registration (Supabase)
POST   /api/auth/login              # Customer login (Supabase)
POST   /api/auth/logout             # Customer logout
POST   /api/auth/reset-password     # Password reset
```

**Customer Portal:**
```
GET    /api/customer/profile        # Get customer profile
PATCH  /api/customer/profile        # Update profile
GET    /api/customer/requests       # Get my requests
GET    /api/customer/requests/[id]  # Get request detail
POST   /api/customer/requests/[id]/files # Upload file
```

**Payments:**
```
POST   /api/quotes                  # Admin creates quote
POST   /api/payments/create         # Create payment link
POST   /api/webhooks/payment        # Payment webhook handler
GET    /api/invoices/[id]           # Get invoice
GET    /api/invoices/[id]/pdf       # Download invoice PDF
```

---

#### Phase 3: Team & Tasks

**User Management:**
```
GET    /api/admin/users             # List team members
POST   /api/admin/users             # Create user
PATCH  /api/admin/users/[id]        # Update user
DELETE /api/admin/users/[id]        # Deactivate user
```

**Task Management:**
```
GET    /api/tasks                   # Get tasks (filtered by user/status)
POST   /api/tasks                   # Create task
PATCH  /api/tasks/[id]              # Update task
DELETE /api/tasks/[id]              # Delete task
GET    /api/tasks/my-tasks          # Get my assigned tasks
```

**Assignments:**
```
POST   /api/orders/[id]/assign      # Assign order to officer
POST   /api/orders/[id]/reassign    # Reassign to different officer
```

---

#### Phase 4: Automation & Reports

**Reports:**
```
GET    /api/reports/revenue         # Revenue stats by date range
GET    /api/reports/services        # Service popularity stats
GET    /api/reports/team            # Team performance stats
GET    /api/reports/sla             # SLA compliance stats
POST   /api/reports/export          # Export data to Excel/CSV
```

**Automation (Cron):**
```
POST   /api/cron/process-emails     # Process email queue (every 5 min)
POST   /api/cron/daily-digest       # Send daily digests (8:30 AM)
POST   /api/cron/sla-check          # Check SLA violations (hourly)
POST   /api/cron/payment-reminders  # Send payment reminders (daily)
```

**Audit:**
```
GET    /api/audit-logs              # Get audit logs (paginated)
GET    /api/audit-logs/[entityId]   # Get logs for specific entity
```

---

### C. Email Templates

All emails use Resend API with bilingual templates (Arabic/English based on customer preference).

#### Phase 1 Emails (2 types)

1. **Quote Request Received** (Customer)
   - **Trigger:** Customer submits quote request
   - **To:** Customer email
   - **Subject:** "Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© / Your Request is Being Reviewed"
   - **Content:** Order number, service name, expected response time
   - **Template:** `quote-request-received.tsx`

2. **New Quote Request** (Admin Alert)
   - **Trigger:** New quote submitted
   - **To:** Admin email
   - **Subject:** "New Quote Request - [Service Name]"
   - **Content:** Customer info, service, urgency, message
   - **Template:** `admin-new-request.tsx`

---

#### Phase 2 Emails (+4 types, total 6)

3. **Quote Sent** (Customer)
   - **Trigger:** Admin creates quote
   - **To:** Customer email
   - **Subject:** "Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø¬Ø§Ù‡Ø² / Your Quote is Ready"
   - **Content:** Price, payment link, expiry (48 hours)
   - **Template:** `quote-sent.tsx`

4. **Payment Confirmed** (Customer)
   - **Trigger:** Webhook confirms payment
   - **To:** Customer email
   - **Subject:** "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø© / Payment Received"
   - **Content:** Amount, invoice link, next steps
   - **Template:** `payment-confirmed.tsx`

5. **Status Changed** (Customer)
   - **Trigger:** Admin updates order status
   - **To:** Customer email
   - **Subject:** "ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ / Update on Your Request"
   - **Content:** New status, description, estimated completion
   - **Template:** `status-changed.tsx`

6. **Order Completed** (Customer)
   - **Trigger:** Status â†’ "Delivered"
   - **To:** Customer email
   - **Subject:** "Ø·Ù„Ø¨Ùƒ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„ / Your Order is Ready"
   - **Content:** Download link, feedback request
   - **Template:** `order-completed.tsx`

---

#### Phase 4 Emails (+4 types, total 10)

7. **Daily Digest** (Officers)
   - **Trigger:** Cron 8:30 AM daily
   - **To:** Each officer with tasks
   - **Subject:** "Your Daily Tasks - [Date]"
   - **Content:** Tasks due today, overdue tasks, at-risk orders
   - **Template:** `daily-digest.tsx`

8. **SLA Warning** (Officer)
   - **Trigger:** Order reaches 70% of SLA time
   - **To:** Assigned officer
   - **Subject:** "Order [#] Approaching Deadline"
   - **Content:** Order details, time remaining, action required
   - **Template:** `sla-warning.tsx`

9. **SLA Breach** (Supervisor + Officer)
   - **Trigger:** Order exceeds SLA deadline
   - **To:** Supervisor + Assigned officer
   - **Subject:** "URGENT: Order [#] Overdue"
   - **Content:** Order details, overdue by X hours, escalation
   - **Template:** `sla-breach.tsx`

10. **Payment Reminder** (Customer)
    - **Trigger:** Quote unpaid after 48 hours
    - **To:** Customer email
    - **Subject:** "ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø¯ÙØ¹ / Payment Reminder"
    - **Content:** Quote details, payment link, expiry warning
    - **Template:** `payment-reminder.tsx`

---

### D. Service Categories & Count

**149 Total Services across 4 main categories:**

#### 1. Translation Services (57 services)

**Document Translation (30 services):**
- Passport translation (EN/AR/HE)
- ID card translation (EN/AR/HE)
- Birth certificate translation (EN/AR/HE)
- Marriage certificate translation (EN/AR/HE)
- Divorce certificate translation (EN/AR/HE)
- Death certificate translation (EN/AR/HE)
- Academic degree translation (EN/AR/HE)
- Academic transcript translation (EN/AR/HE)
- Driving license translation (EN/AR/HE)
- Medical report translation (EN/AR/HE)
- (20 more document types Ã— 3 language combinations)

**Legal Translation (12 services):**
- Contract translation (certified)
- Court document translation
- Power of attorney translation
- Notarized document translation
- Legal correspondence
- Business agreement translation
- (6 more legal document types)

**Business Translation (10 services):**
- Company registration documents
- Financial statements translation
- Business plan translation
- Marketing materials translation
- Technical documentation translation
- (5 more business document types)

**Other Translation (5 services):**
- Website localization
- App localization
- Manual translation
- Letter translation
- Email translation

---

#### 2. Government Services - Ministry of Interior (42 services)

**Civil Affairs (15 services):**
- ID card renewal
- ID card replacement (lost/damaged)
- Birth certificate issuance
- Marriage certificate issuance
- Divorce certificate issuance
- Death certificate issuance
- Family registry extract
- Civil status certificate
- Non-criminal record certificate
- Residency certificate
- (5 more civil documents)

**Passport Services (8 services):**
- Passport issuance (new)
- Passport renewal
- Passport replacement (lost/stolen)
- Emergency travel document
- Child passport
- Passport amendment
- (2 more passport services)

**Police Services (10 services):**
- Police clearance certificate
- Traffic violation clearance
- Vehicle registration
- Vehicle transfer
- License plate issuance
- Vehicle inspection report
- (4 more police services)

**Other Interior Services (9 services):**
- General power of attorney
- Special power of attorney
- Inheritance certificate
- Name change request
- (5 more services)

---

#### 3. Government Services - Other Ministries (35 services)

**Ministry of Transport (8 services):**
- Driving license issuance
- Driving license renewal
- International driving permit
- Driver training certificate
- Vehicle import clearance
- (3 more services)

**Ministry of Economy (10 services):**
- Company registration
- Trade license issuance
- Business name registration
- Tax registration
- Chamber of Commerce membership
- Export license
- Import license
- (3 more services)

**Ministry of Health (7 services):**
- Health certificate
- Medical fitness certificate
- Vaccination certificate
- Food handling permit
- Medical practice license
- (2 more services)

**Ministry of Education (5 services):**
- Degree attestation
- Transcript attestation
- Study certificate
- School transfer certificate
- Equivalency certificate

**Ministry of Labor (5 services):**
- Work permit
- Employee registration
- Labor contract attestation
- Work clearance certificate
- Social security registration

---

#### 4. Business & Consulting Services (15 services)

**Legal Consulting:**
- Contract review
- Legal consultation (1 hour)
- Business structure advice
- Compliance consultation
- Dispute resolution advice

**Business Setup:**
- Company formation package
- Business plan development
- Tax setup consultation
- Accounting setup
- Licensing guidance

**Administrative Support:**
- Document notarization assistance
- Government liaison service
- Appointment booking service
- Document delivery service
- Express processing (any service +50%)

---

### E. Local Development Setup

#### Prerequisites
```bash
# Required
Node.js 18+ (recommended: 20.x)
npm 9+ or pnpm 8+
Git

# Optional
VS Code (recommended)
- Extensions: ESLint, Prettier, Tailwind CSS IntelliSense
```

#### Step-by-Step Setup

1. **Clone Repository**
```bash
git clone <repo-url>
cd tasheel-platform
```

2. **Install Dependencies**
```bash
npm install
# or
pnpm install
```

3. **Setup Supabase**
```bash
# Option A: Use existing project (provided by client)
# Copy .env.example to .env.local
cp .env.example .env.local

# Add Supabase credentials (client provides)
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...
```

```bash
# Option B: Create new Supabase project
# 1. Go to https://supabase.com
# 2. Create new project
# 3. Copy URL and keys to .env.local
# 4. Run migrations (Phase-by-phase)
```

4. **Setup Admin Auth**
```bash
# Generate secure session secret
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# Add to .env.local
ADMIN_SESSION_SECRET=<generated-secret>
ADMIN_EMAIL=admin@tasheel.ps
ADMIN_PASSWORD=your-password
```

5. **Setup Resend (Email)**
```bash
# Get API key from https://resend.com
# Add to .env.local
RESEND_API_KEY=re_xxxxx
EMAIL_FROM=Tasheel <noreply@tasheel.ps>
```

6. **Run Database Migrations**
```bash
# Phase 1 migrations
npm run supabase:migrate:phase1

# Or manually via Supabase Dashboard > SQL Editor
# Copy SQL from TECHNICAL_SPEC.md Phase 1 section
```

7. **Seed Initial Data**
```bash
# Add 30 services for Phase 1
npm run seed:services

# Or manually insert via Supabase Dashboard > Table Editor
```

8. **Run Development Server**
```bash
npm run dev
```

9. **Access Application**
```
Public Site:    http://localhost:3000
Admin Panel:    http://localhost:3000/login
```

10. **Test Admin Login**
```
Email: admin@tasheel.ps (from .env.local)
Password: <your-password>
```

---

### F. Third-Party Setup Guides

#### Resend Email Setup

1. **Create Account:** https://resend.com
2. **Verify Domain:**
   - Add DNS records for tasheel.ps
   - SPF: `v=spf1 include:_spf.resend.com ~all`
   - DKIM: (provided by Resend)
3. **Get API Key:** Dashboard > API Keys > Create
4. **Rate Limits:**
   - Free: 3,000 emails/month, 100/day
   - Pro: $20/month for 50,000 emails

---

#### PalPay Setup (Option A)

1. **Register:** Contact PalPay Palestine
2. **Get Credentials:**
   - Merchant ID
   - API Key
   - Webhook Secret
3. **Setup Webhook:**
   - URL: `https://tasheel.ps/api/webhooks/payment`
   - Events: `payment.success`, `payment.failed`
4. **Test Mode:**
   - Use sandbox credentials during development
   - Test cards provided by PalPay

---

#### PayTabs Setup (Option B)

1. **Register:** https://paytabs.com
2. **Get Credentials:**
   - Server Key
   - Profile ID
   - Webhook Secret
3. **Setup Webhook:**
   - URL: `https://tasheel.ps/api/webhooks/payment`
   - Events: `payment_success`, `payment_failure`
4. **Supported Cards:**
   - Visa, Mastercard, Mada (Saudi)

---

### G. Production Checklist

Before going live, ensure:

**Phase 1:**
- [ ] Domain configured (tasheel.ps)
- [ ] SSL certificate active
- [ ] Supabase production project created
- [ ] All 30 services added to database
- [ ] Admin credentials secured
- [ ] Email domain verified (Resend)
- [ ] Contact form working
- [ ] Track order working
- [ ] Admin panel accessible

**Phase 2:**
- [ ] Supabase Auth configured
- [ ] Email templates tested
- [ ] Payment gateway in production mode
- [ ] Webhook endpoint secured (signature verification)
- [ ] Invoice PDF generation working
- [ ] Customer can register/login
- [ ] File upload/download working
- [ ] RLS policies tested

**Phase 3:**
- [ ] All 149 services added
- [ ] 5 user roles configured
- [ ] Team members created
- [ ] Task management tested
- [ ] SLA tracking working
- [ ] Workflows configured

**Phase 4:**
- [ ] Cron jobs configured (Netlify Functions or Vercel Cron)
- [ ] Daily digest emails sending
- [ ] SLA alerts working
- [ ] Payment reminders sending
- [ ] Kanban board functional
- [ ] Reports generating correctly

**Security:**
- [ ] All RLS policies active
- [ ] API routes protected
- [ ] Webhook signatures verified
- [ ] Admin session secure
- [ ] CORS configured correctly
- [ ] Rate limiting enabled

**Performance:**
- [ ] Database indexes created
- [ ] Images optimized
- [ ] Next.js caching enabled
- [ ] CDN configured (Netlify Edge)
- [ ] Lighthouse score >90

---

**END OF TECHNICAL SPEC**

This is your complete master blueprint. Build phase by phase, test thoroughly, deploy weekly. Good luck! ğŸš€